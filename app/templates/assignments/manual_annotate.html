{% extends "base.html" %}

{% block title %}æ‰‹åŠ¨åœˆç”» - {{ submission.enrollment.student.user.full_name }}{% endblock %}

{% block head %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3 top-bar">
        <a href="{{ url_for('assignments.review_submission', submission_id=submission.id) }}" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            <span class="back-text">è¿”å›</span>
        </a>
        
        <!-- å·¥å…·æ  -->
        <div class="tools-section d-flex gap-2 align-items-center">
            <!-- å·¥å…·æŒ‰é’®ç»„ -->
            <div class="tool-buttons d-flex gap-1">
                <div class="dropdown">
                    <button class="btn btn-outline-secondary tool-btn" type="button" data-tool="pen" title="åœ†ç ç¬”">
                        <i class="fas fa-pen"></i>
                        <span class="tool-name d-none d-md-inline ms-1">åœ†ç ç¬”</span>
                    </button>
                    <div class="dropdown-menu tool-settings-dropdown" data-tool="pen">
                        <div class="p-3">
                            <div class="settings-row mb-2">
                                <label class="form-label"><i class="fas fa-palette me-1"></i>é¢œè‰²</label>
                                <div class="color-picker d-flex gap-1">
                                    <button class="color-btn" style="background-color: #FF0000;" data-color="#FF0000"></button>
                                    <button class="color-btn" style="background-color: #00FF00;" data-color="#00FF00"></button>
                                    <button class="color-btn" style="background-color: #0000FF;" data-color="#0000FF"></button>
                                    <button class="color-btn active" style="background-color: #000000;" data-color="#000000"></button>
                                </div>
                            </div>
                            <div class="settings-row mb-2">
                                <label class="form-label"><i class="fas fa-pen me-1"></i>ç²—ç»†</label>
                                <div class="d-flex align-items-center gap-2">
                                    <input type="range" class="form-range flex-grow-1" min="1" max="20" value="2" data-key="thickness">
                                    <span class="slider-value">2</span>
                                </div>
                            </div>
                            <canvas class="preview-canvas border rounded" width="200" height="40"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="dropdown">
                    <button class="btn btn-outline-secondary tool-btn" type="button" data-tool="highlighter" title="è§å…‰ç¬”">
                        <i class="fas fa-highlighter"></i>
                        <span class="tool-name d-none d-md-inline ms-1">è§å…‰ç¬”</span>
                    </button>
                    <div class="dropdown-menu tool-settings-dropdown" data-tool="highlighter">
                        <div class="p-3">
                            <div class="settings-row mb-2">
                                <label class="form-label"><i class="fas fa-palette me-1"></i>é¢œè‰²</label>
                                <div class="color-picker d-flex gap-1">
                                    <button class="color-btn active" style="background-color: #FFFF00;" data-color="#FFFF00"></button>
                                    <button class="color-btn" style="background-color: #FF69B4;" data-color="#FF69B4"></button>
                                    <button class="color-btn" style="background-color: #00FF00;" data-color="#00FF00"></button>
                                    <button class="color-btn" style="background-color: #0000FF;" data-color="#0000FF"></button>
                                </div>
                            </div>
                            <div class="settings-row mb-2">
                                <label class="form-label"><i class="fas fa-pen me-1"></i>ç²—ç»†</label>
                                <div class="d-flex align-items-center gap-2">
                                    <input type="range" class="form-range flex-grow-1" min="1" max="20" value="10" data-key="thickness">
                                    <span class="slider-value">10</span>
                                </div>
                            </div>
                            <canvas class="preview-canvas border rounded" width="200" height="40"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="dropdown">
                    <button class="btn btn-outline-secondary tool-btn" type="button" data-tool="wavy" title="æ³¢æµªçº¿">
                        <i class="fas fa-wave-square"></i>
                        <span class="tool-name d-none d-md-inline ms-1">æ³¢æµªçº¿</span>
                    </button>
                    <div class="dropdown-menu tool-settings-dropdown" data-tool="wavy">
                        <div class="p-3">
                            <div class="settings-row mb-2">
                                <label class="form-label"><i class="fas fa-palette me-1"></i>é¢œè‰²</label>
                                <div class="color-picker d-flex gap-1">
                                    <button class="color-btn" style="background-color: #FF0000;" data-color="#FF0000"></button>
                                    <button class="color-btn" style="background-color: #00FF00;" data-color="#00FF00"></button>
                                    <button class="color-btn" style="background-color: #0000FF;" data-color="#0000FF"></button>
                                    <button class="color-btn active" style="background-color: #000000;" data-color="#000000"></button>
                                </div>
                            </div>
                            <div class="settings-row mb-2">
                                <label class="form-label"><i class="fas fa-pen me-1"></i>ç²—ç»†</label>
                                <div class="d-flex align-items-center gap-2">
                                    <input type="range" class="form-range flex-grow-1" min="1" max="20" value="2" data-key="thickness">
                                    <span class="slider-value">2</span>
                                </div>
                            </div>
                            <div class="settings-row mb-2">
                                <label class="form-label"><i class="fas fa-arrows-alt-v me-1"></i>é«˜åº¦</label>
                                <div class="d-flex align-items-center gap-2">
                                    <input type="range" class="form-range flex-grow-1" min="1" max="20" value="5" data-key="height">
                                    <span class="slider-value">5</span>
                                </div>
                            </div>
                            <div class="settings-row mb-2">
                                <label class="form-label"><i class="fas fa-compress-alt me-1"></i>å¯†åº¦</label>
                                <div class="d-flex align-items-center gap-2">
                                    <input type="range" class="form-range flex-grow-1" min="1" max="10" value="4" data-key="density">
                                    <span class="slider-value">4</span>
                                </div>
                            </div>
                            <canvas class="preview-canvas border rounded" width="200" height="40"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="dropdown">
                    <button class="btn btn-outline-secondary tool-btn" type="button" data-tool="eraser" title="æ©¡çš®æ“¦">
                        <i class="fas fa-eraser"></i>
                        <span class="tool-name d-none d-md-inline ms-1">æ©¡çš®æ“¦</span>
                    </button>
                    <div class="dropdown-menu tool-settings-dropdown" data-tool="eraser">
                        <div class="p-3">
                            <div class="settings-row mb-2">
                                <label class="form-label"><i class="fas fa-eraser me-1"></i>æ¨¡å¼</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="eraser-mode" id="mode-partial" value="partial" checked>
                                    <label class="btn btn-outline-primary" for="mode-partial">éƒ¨åˆ†æ“¦é™¤</label>
                                    <input type="radio" class="btn-check" name="eraser-mode" id="mode-object" value="object">
                                    <label class="btn btn-outline-primary" for="mode-object">å¯¹è±¡æ“¦é™¤</label>
                                </div>
                            </div>
                            <div class="settings-row mb-2" id="eraser-size-row">
                                <label class="form-label"><i class="fas fa-expand me-1"></i>å¤§å°</label>
                                <div class="d-flex align-items-center gap-2">
                                    <input type="range" class="form-range flex-grow-1" min="5" max="50" value="10" data-key="size">
                                    <span class="slider-value">10</span>
                                </div>
                            </div>
                            <canvas class="preview-canvas border rounded" width="200" height="40"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- è®¾å¤‡æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
            <!-- <div class="device-mode-toggle ms-2">
                <button id="device-toggle" class="btn btn-outline-secondary" title="åˆ‡æ¢è®¾å¤‡æ¨¡å¼">
                    <i class="fas fa-mobile-alt" id="device-mode-icon"></i>
                    <span class="device-mode-text d-none d-md-inline ms-1" id="device-mode-text">ç§»åŠ¨ç«¯</span>
                </button>
            </div> -->
        </div>
        
        <div class="action-buttons">
            <button id="undo" class="btn btn-info" title="æ’¤é”€">
                <i class="fas fa-undo"></i> <span class="btn-text">æ’¤é”€</span>
            </button>
            <button id="redo" class="btn btn-info" title="é‡åš">
                <i class="fas fa-redo"></i> <span class="btn-text">é‡åš</span>
            </button>
            <button id="clear" class="btn btn-warning" title="æ¸…ç©º">
                <i class="fas fa-trash"></i> <span class="btn-text">æ¸…ç©º</span>
            </button>
            <button id="save" class="btn btn-primary" title="ä¿å­˜">
                <i class="fas fa-save"></i> <span class="btn-text">ä¿å­˜</span>
            </button>
        </div>
    </div>
    <div class="position-relative image-container">
        <img id="original-image" src="{{ url_for('main.uploaded_file', filename=image_filename) }}" alt="Original Image" style="display: block; width: 100%; height: auto;">
        <canvas id="canvas" style="position: absolute; top: 0; left: 0; touch-action: none; width: 100%; height: 100%;"></canvas>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    /* åŸºç¡€æ ·å¼ */
    body {
        margin: 0;
        padding: 0;
        overflow-x: hidden;
    }
    
    .container-fluid {
        padding: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
    }
    
    /* è¿”å›æŒ‰é’® */
    .back-btn {
        background: transparent;
        border: 1px solid #dee2e6;
        color: #495057;
        padding: 8px 12px;
        border-radius: 8px;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .back-btn:hover {
        background: #f8f9fa;
        color: #495057;
        text-decoration: none;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    /* é¡¶éƒ¨æ“ä½œæ  */
    .top-bar {
        background: white;
        border-bottom: 1px solid #e0e0e0;
        padding: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        z-index: 100;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .action-buttons {
        display: flex;
        gap: 8px;
        background: white;
        border: 1px solid #e0e0e0;
        padding: 8px;
        border-radius: 12px;
    }
    
    .action-buttons .btn {
        padding: 8px 14px;
        font-size: 0.85rem;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        font-weight: 500;
        transition: all 0.3s ease;
        background: #f8f9fa;
        color: #333;
    }
    
    .action-buttons .btn-info {
        background: #17a2b8;
        color: white;
        border-color: #17a2b8;
    }
    
    .action-buttons .btn-info:hover {
        background: #138496;
        border-color: #117a8b;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .action-buttons .btn-warning {
        background: #ffc107;
        color: #212529;
        border-color: #ffc107;
    }
    
    .action-buttons .btn-warning:hover {
        background: #e0a800;
        border-color: #d39e00;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .action-buttons .btn-primary {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .action-buttons .btn-primary:hover {
        background: #0056b3;
        border-color: #004085;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    /* è®¾å¤‡æ¨¡å¼åˆ‡æ¢æŒ‰é’® */
    .device-mode-toggle {
        display: flex;
        align-items: center;
    }
    
    #device-toggle {
        padding: 10px 16px;
        font-size: 0.9rem;
        border-radius: 12px;
        font-weight: 600;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        border: 2px solid #e0e7ff;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        color: #64748b;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
    }
    
    #device-toggle::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        transition: left 0.5s;
    }
    
    #device-toggle:hover::before {
        left: 100%;
    }
    
    #device-toggle:hover {
        background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
        border-color: #c7d2fe;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    #device-toggle:active {
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    
    /* å¼ºåˆ¶ç§»åŠ¨ç«¯æ¨¡å¼æ ·å¼ */
    #device-toggle.mobile-mode {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border-color: #3b82f6;
        color: #1d4ed8;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
    }
    
    #device-toggle.mobile-mode:hover {
        background: linear-gradient(135deg, #bfdbfe 0%, #93c5fd 100%);
        border-color: #1d4ed8;
        box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
    }
    
    /* å¼ºåˆ¶æ¡Œé¢ç«¯æ¨¡å¼æ ·å¼ */
    #device-toggle.desktop-mode {
        background: linear-gradient(135deg, #fae8ff 0%, #f3e8ff 100%);
        border-color: #a855f7;
        color: #7c3aed;
        box-shadow: 0 2px 8px rgba(168, 85, 247, 0.2);
    }
    
    #device-toggle.desktop-mode:hover {
        background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
        border-color: #7c3aed;
        box-shadow: 0 4px 16px rgba(168, 85, 247, 0.3);
    }
    
    /* è‡ªåŠ¨æ£€æµ‹æ¨¡å¼æ ·å¼ */
    #device-toggle.auto-mode {
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        border-color: #22c55e;
        color: #15803d;
        box-shadow: 0 2px 8px rgba(34, 197, 94, 0.2);
    }
    
    #device-toggle.auto-mode:hover {
        background: linear-gradient(135deg, #bbf7d0 0%, #86efac 100%);
        border-color: #15803d;
        box-shadow: 0 4px 16px rgba(34, 197, 94, 0.3);
    }
    
    /* å›¾ç‰‡å®¹å™¨ */
    .image-container {
        flex: 1;
        position: relative;
        overflow: auto;
        background: #f8f9fa;
    }
    
    #original-image {
        display: block;
        max-width: 100%;
        height: auto;
        margin: 0 auto;
    }
    
    #canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        touch-action: none;
        cursor: crosshair;
    }
    
    /* å·¥å…·æ  */
    .tool-bar {
        background: #fff;
        border-top: 1px solid #e9ecef;
        padding: 12px 16px;
        display: flex;
        justify-content: center;
        gap: 16px;
        flex-shrink: 0;
        z-index: 100;
    }
    
    .tool-btn {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .tool-btn i {
        font-size: 1.2rem;
        color: #495057;
    }
    
    .tool-btn:hover {
        background: #e9ecef;
        border-color: #adb5bd;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .tool-btn.active {
        background: #007bff;
        border-color: #007bff;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,123,255,0.3);
    }
    
    .tool-btn.active i {
        color: white;
    }
    
    /* æ–°å·¥å…·æŒ‰é’®æ ·å¼ */
    .tools-section .tool-btn {
        border: 2px solid #ddd;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 16px;
        color: #666;
        padding: 8px 12px;
        width: auto;
        height: auto;
    }
    
    .tools-section .tool-btn:hover {
        border-color: #007bff;
        background: #f8f9fa;
        transform: translateY(-1px);
    }
    
    .tools-section .tool-btn.active {
        border-color: #007bff;
        background: #007bff;
        color: white;
        box-shadow: 0 2px 8px rgba(0,123,255,0.3);
    }
    
    .tools-section .tool-btn.dropdown-toggle::after {
        margin-left: 0.5em;
    }
    
    /* å·¥å…·è®¾ç½®ä¸‹æ‹‰èœå•æ ·å¼ */
    .tool-settings-dropdown {
        min-width: 250px;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .tool-settings-dropdown .settings-row {
        margin-bottom: 12px;
    }
    
    .tool-settings-dropdown .form-label {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 6px;
        color: #333;
    }
    
    /* é¢œè‰²é€‰æ‹©å™¨æ ·å¼ */
    .color-picker .color-btn {
        width: 30px;
        height: 30px;
        border: 2px solid #ddd;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .color-picker .color-btn:hover {
        transform: scale(1.1);
        border-color: #007bff;
    }
    
    .color-picker .color-btn.active {
        border-color: #007bff;
        border-width: 3px;
        transform: scale(1.1);
    }
    
    /* æ»‘å—æ ·å¼ */
    .form-range {
        height: 6px;
    }
    
    .slider-value {
        font-size: 14px;
        font-weight: 600;
        color: #666;
        min-width: 30px;
        text-align: center;
    }
    
    /* é¢„è§ˆç”»å¸ƒæ ·å¼ */
    .preview-canvas {
        background: #f8f9fa;
        margin-top: 8px;
    }
    
    /* æ©¡çš®æ“¦æ¨¡å¼æŒ‰é’®ç»„ */
    .btn-group .btn {
        font-size: 12px;
        padding: 6px 12px;
    }
    
    /* è®¾ç½®ä¸‹æ‹‰æ¡† */
    .settings-dropdown {
        position: fixed;
        top: 70px;
        left: 12px;
        right: 12px;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 12px 32px rgba(0,0,0,0.2);
        z-index: 1001;
        max-height: calc(100vh - 140px);
        overflow-y: auto;
        color: #212529;
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .settings-dropdown.visible {
        opacity: 1;
        transform: translateY(0);
    }
    
    .settings-dropdown:before {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 50%;
        margin-left: -10px;
        border: 10px solid transparent;
        border-top-color: white;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }
    
    /* è®¾ç½®é¡¹æ¨ªå‘å¸ƒå±€ */
    .settings-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
        flex-wrap: wrap;
    }
    
    .settings-row:last-child {
        margin-bottom: 0;
    }
    
    .settings-label {
        font-size: 14px;
        font-weight: 500;
        color: #495057;
        min-width: 40px;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .settings-label i {
        font-size: 16px;
    }
    
    .color-picker {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .color-picker button {
        width: 44px;
        height: 44px;
        border-radius: 8px;
        border: 2px solid #dee2e6;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }
    
    .color-picker button:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .color-picker button.active {
        border-color: #007bff;
        transform: scale(1.05);
        box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
    }
    
    .color-picker button.active::after {
        content: 'âœ“';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-weight: bold;
        text-shadow: 0 0 2px rgba(0,0,0,0.5);
    }
    
    /* æ»‘å—æ ·å¼ä¼˜åŒ– */
    .settings-slider {
        flex: 1;
        min-width: 100px;
        max-width: 150px;
    }
    
    .settings-slider input[type="range"] {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: #dee2e6;
        outline: none;
        -webkit-appearance: none;
    }
    
    .settings-slider input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #007bff;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .settings-slider input[type="range"]::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #007bff;
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .slider-value {
        font-size: 12px;
        color: #6c757d;
        min-width: 24px;
        text-align: center;
    }
    
    .mode-buttons {
        display: flex;
        gap: 8px;
    }
    
    .mode-buttons button {
        flex: 1;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }
    
    .mode-buttons button.active {
        background-color: #007bff;
        border-color: #007bff;
        color: white;
    }
    
    /* æ»‘å—æ ·å¼ */
    input[type="range"] {
        -webkit-appearance: none;
        width: 100%;
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        outline: none;
        margin: 8px 0;
    }
    
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        background: #007bff;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        transition: all 0.2s ease;
    }
    
    input[type="range"]::-webkit-slider-thumb:hover {
        transform: scale(1.2);
        box-shadow: 0 3px 8px rgba(0,0,0,0.3);
    }
    
    input[type="range"]::-moz-range-track {
        background: #e9ecef;
        border-radius: 3px;
        height: 6px;
        border: none;
    }
    
    input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        background: #007bff;
        border-radius: 50%;
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    
    /* é¢„è§ˆç”»å¸ƒ */
    canvas[data-preview="true"] {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        background: #f8f9fa;
    }
    
    /* ç§»åŠ¨è®¾å¤‡ä¼˜åŒ– - é¡¶éƒ¨æ§åˆ¶æ å¸ƒå±€ */
    .mobile-device .top-bar {
        padding: 8px 12px !important;
        flex-direction: row !important;
        justify-content: space-between !important;
        align-items: center !important;
        background: #fff !important;
        border-bottom: 1px solid #e9ecef !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        z-index: 1000 !important;
        height: 60px !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
    }
    
    .mobile-device .back-btn {
        padding: 8px 12px !important;
        font-size: 14px !important;
        background: #6c757d !important;
        color: white !important;
        border: none !important;
        border-radius: 6px !important;
        text-decoration: none !important;
        display: flex !important;
        align-items: center !important;
        gap: 4px !important;
    }
    
    .mobile-device .back-text {
        display: inline !important;
    }
    
    .mobile-device .action-buttons {
        display: flex !important;
        gap: 8px !important;
        padding: 0 !important;
    }
    
    .mobile-device .action-buttons .btn {
         font-size: 12px !important;
         padding: 6px 8px !important;
         border-radius: 6px !important;
         min-width: 50px !important;
         height: 36px !important;
     }
     
     .mobile-device .action-buttons .btn .btn-text {
         display: none !important;
     }
     
     /* ç§»åŠ¨ç«¯æ˜¾ç¤ºå·¥å…·é€‰æ‹©å™¨ï¼Œéšè—æ¡Œé¢ç«¯å·¥å…· */
     .mobile-device .mobile-tools {
         display: flex !important;
         gap: 8px !important;
     }
     
     header.top-navbar,
.sidebar,
nav.bottom-navbar {
    display: none !important;
    visibility: hidden !important;
}

.main-content {
    margin-left: 0 !important;
    padding-top: 0 !important;
    padding-bottom: 0 !important;
    width: 100% !important;
}

.content-area {
    padding: 0 !important;
    margin: 0 !important;
}

.container-fluid {
    padding: 0 !important;
    margin: 0 !important;
    max-width: 100% !important;
    width: 100% !important;
}

/* å¼ºåˆ¶éšè—æ‰€æœ‰å¯èƒ½çš„å¯¼èˆªå…ƒç´  */
header,
nav:not(.mobile-tools),
.navbar {
    display: none !important;
}

/* æ¡Œé¢ç«¯éšè—å·¥å…·é€‰æ‹©å™¨ */
.desktop-tools {
    display: none !important;
}

.mobile-tools {
    display: flex !important;
    gap: 8px !important;
}
     
     .mobile-device .top-bar {
         position: fixed !important;
         top: 0 !important;
         left: 0 !important;
         right: 0 !important;
         z-index: 1000 !important;
         padding: 8px 12px !important;
         display: flex !important;
         justify-content: space-between !important;
         align-items: center !important;
         background: #ffffff !important;
         border-bottom: 1px solid #dee2e6 !important;
         box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
         height: 56px !important;
     }
     
     .mobile-device .back-btn {
         padding: 8px 16px !important;
         font-size: 14px !important;
         background: #6c757d !important;
         color: white !important;
         border-radius: 8px !important;
         display: flex !important;
         align-items: center !important;
         text-decoration: none !important;
         border: none !important;
         font-weight: 500 !important;
     }
     
     .mobile-device .back-btn:hover {
         background: #5a6268 !important;
         color: white !important;
         text-decoration: none !important;
     }
     
     .mobile-device .action-buttons {
         display: flex !important;
         gap: 8px !important;
     }
     
     .mobile-device .action-buttons .btn {
         padding: 6px 12px !important;
         font-size: 12px !important;
         border-radius: 6px !important;
         min-width: 50px !important;
         height: 36px !important;
         font-weight: 500 !important;
     }
     
     .mobile-device .tool-bar {
         display: none !important;
     }
     
     /* ç§»åŠ¨ç«¯å·¥å…·æ  */
     .mobile-device .mobile-tools {
         position: fixed !important;
         bottom: 0 !important;
         left: 0 !important;
         right: 0 !important;
         background: white !important;
         border-top: 1px solid #dee2e6 !important;
         padding: 12px !important;
         display: flex !important;
         justify-content: center !important;
         gap: 12px !important;
         z-index: 1000 !important;
         box-shadow: 0 -2px 8px rgba(0,0,0,0.1) !important;
         height: 70px !important;
         align-items: center !important;
     }
     
     .mobile-device .image-container {
         position: fixed !important;
         top: 56px !important;
         left: 0 !important;
         right: 0 !important;
         bottom: 70px !important;
         overflow: auto !important;
         padding: 0 !important;
         background: #f8f9fa !important;
         display: flex !important;
         align-items: center !important;
         justify-content: center !important;
     }
     
     .mobile-device #original-image {
         display: block !important;
         max-width: 100% !important;
         max-height: 100% !important;
         width: auto !important;
         height: auto !important;
         object-fit: contain !important;
     }
     
     .mobile-device #canvas {
         position: absolute !important;
         top: 0 !important;
         left: 0 !important;
         touch-action: none !important;
         pointer-events: auto !important;
     }
     
     .mobile-device .settings-dropdown {
         position: absolute !important;
         top: 100% !important;
         right: 0 !important;
         max-height: 200px !important;
         overflow-y: auto !important;
     }
     
     .mobile-device .color-picker {
         width: 25px !important;
         height: 25px !important;
     }
     
     /* Hide button text on mobile */
     .mobile-device .btn-text {
         display: none !important;
     }
     
     /* Mobile tool buttons styling */
     .mobile-device .mobile-tool-btn {
         border: 1px solid #dee2e6 !important;
         background: #ffffff !important;
         transition: all 0.2s ease !important;
     }
     
     .mobile-device .mobile-tool-btn:hover {
         background: #f8f9fa !important;
         border-color: #adb5bd !important;
     }
     
     .mobile-device .mobile-tool-btn.active {
         background: #007bff !important;
         border-color: #007bff !important;
         color: white !important;
     }
    
    /* éšè—å·¥å…·æ ï¼Œå°†å·¥å…·é›†æˆåˆ°é¡¶éƒ¨ */
    .mobile-device .tool-bar {
        display: none !important;
    }
    
    /* å›¾ç‰‡å®¹å™¨å…¨å±æ˜¾ç¤º */
    .mobile-device .image-container {
        position: fixed !important;
        top: 60px !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        background: #f8f9fa !important;
        overflow: hidden !important;
        padding: 0 !important;
    }
    
    /* Canvas å…¨å±é€‚é… */
    .mobile-device #original-image {
        position: absolute !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        max-width: none !important;
        max-height: none !important;
        width: auto !important;
        height: auto !important;
        touch-action: none !important;
    }
    
    .mobile-device #canvas {
        position: absolute !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        touch-action: none !important;
        cursor: crosshair !important;
    }
    
    /* è®¾ç½®ä¸‹æ‹‰æ¡†é€‚é… */
    .mobile-device .settings-dropdown {
        position: fixed !important;
        top: 70px !important;
        left: 8px !important;
        right: 8px !important;
        max-height: calc(100vh - 80px) !important;
        z-index: 1001 !important;
    }
    
    .mobile-device .color-picker button {
        width: 32px !important;
        height: 32px !important;
    }
    
    /* å¼ºåˆ¶ç§»åŠ¨ç«¯æ ·å¼ - é€šè¿‡JavaScriptç±»æ§åˆ¶ */
    .mobile-device .top-bar {
        padding: 8px 12px !important;
        flex-direction: row !important;
        justify-content: space-between !important;
    }
    
    .mobile-device .back-btn {
        padding: 6px 8px !important;
        font-size: 12px !important;
    }
    
    .mobile-device .back-text {
        display: none !important;
    }
    
    .mobile-device .action-buttons {
        gap: 4px !important;
        padding: 4px !important;
    }
    
    .mobile-device .action-buttons .btn {
        font-size: 0.7rem !important;
        padding: 4px 8px !important;
    }
    
    .mobile-device .tool-bar {
        padding: 8px 12px !important;
        gap: 12px !important;
    }
    
    .mobile-device .tool-btn {
        width: 48px !important;
        height: 48px !important;
    }
    
    /* è¶…å°å±å¹•ä¼˜åŒ– - ç§»åŠ¨è®¾å¤‡ç«–å± */
    @media screen and (max-width: 480px) and (orientation: portrait),
           screen and (max-width: 480px) and (pointer: coarse) {
        .top-bar {
            flex-direction: column;
            gap: 8px;
            padding: 8px;
        }
        
        .back-btn {
            align-self: flex-start;
            padding: 4px 6px;
            font-size: 11px;
        }
        
        .action-buttons {
            width: 100%;
            justify-content: space-between;
            padding: 4px;
        }
        
        .action-buttons .btn {
            flex: 1;
            margin: 0 1px;
            font-size: 0.65rem;
            padding: 3px 6px;
        }
        
        .tool-bar {
            gap: 8px;
            padding: 6px 8px;
        }
        
        .tool-btn {
            width: 44px;
            height: 44px;
        }
        
        .tool-btn i {
            font-size: 1rem;
        }
        
        .settings-dropdown {
            width: calc(100vw - 16px);
            padding: 16px;
        }
        
        .image-container {
            padding-bottom: 90px;
        }
    }
    
    /* æ¨ªå±æ¨¡å¼ä¼˜åŒ– - ç§»åŠ¨è®¾å¤‡æ¨ªå± */
    @media screen and (orientation: landscape) and (max-height: 500px),
           screen and (orientation: landscape) and (pointer: coarse),
           screen and (orientation: landscape) and (hover: none) {
        .top-bar {
            padding: 4px 8px;
            flex-direction: row;
        }
        
        .back-btn {
            padding: 4px 6px;
            font-size: 11px;
        }
        
        .back-text {
            display: none;
        }
        
        .action-buttons {
            gap: 2px;
            padding: 2px;
        }
        
        .action-buttons .btn {
            font-size: 0.6rem;
            padding: 2px 4px;
        }
        
        .tool-bar {
            padding: 4px 8px;
        }
        
        .tool-btn {
            width: 36px;
            height: 36px;
        }
        
        .image-container {
            padding-bottom: 50px;
        }
    }
    
    /* å¼ºåˆ¶æ¨ªå±ç§»åŠ¨ç«¯æ ·å¼ - é€šè¿‡JavaScriptç±»æ§åˆ¶ */
    .mobile-device.landscape-mode .top-bar {
        padding: 4px 8px !important;
        flex-direction: row !important;
    }
    
    .mobile-device.landscape-mode .back-btn {
        padding: 4px 6px !important;
        font-size: 11px !important;
    }
    
    .mobile-device.landscape-mode .back-text {
        display: none !important;
    }
    
    .mobile-device.landscape-mode .action-buttons {
        gap: 2px !important;
        padding: 2px !important;
    }
    
    .mobile-device.landscape-mode .action-buttons .btn {
        font-size: 0.6rem !important;
        padding: 2px 4px !important;
    }
    
    .mobile-device.landscape-mode .tool-bar {
        padding: 4px 8px !important;
    }
    
    .mobile-device.landscape-mode .tool-btn {
        width: 36px !important;
        height: 36px !important;
    }
    
    .mobile-device.landscape-mode .image-container {
        padding-bottom: 50px !important;
    }
    
    /* ç§»åŠ¨è®¾å¤‡æ¨ªå±ç‰¹æ®Šæ ·å¼ - å¼ºåˆ¶ä¿æŒç§»åŠ¨ç«¯UI */
    .mobile-device.mobile-landscape {
        /* ç¡®ä¿æ¨ªå±æ—¶ä»ç„¶ä½¿ç”¨ç§»åŠ¨ç«¯å¸ƒå±€ï¼Œä¸è¢«æ¡Œé¢ç«¯æ ·å¼è¦†ç›– */
    }
    
    .mobile-device.mobile-landscape .top-bar {
        padding: 4px 8px !important;
        flex-direction: row !important;
        height: 40px !important;
    }
    
    .mobile-device.mobile-landscape .back-btn {
        padding: 3px 6px !important;
        font-size: 10px !important;
        height: 28px !important;
    }
    
    .mobile-device.mobile-landscape .back-text {
        display: none !important;
    }
    
    .mobile-device.mobile-landscape .action-buttons {
        gap: 2px !important;
        padding: 2px !important;
    }
    
    .mobile-device.mobile-landscape .action-buttons .btn {
        font-size: 0.55rem !important;
        padding: 2px 4px !important;
        height: 28px !important;
    }
    
    .mobile-device.mobile-landscape .mobile-tools {
        height: 50px !important;
        padding: 8px !important;
    }
    
    .mobile-device.mobile-landscape .tool-btn {
        width: 32px !important;
        height: 32px !important;
    }
    
    .mobile-device.mobile-landscape .image-container {
        top: 40px !important;
        bottom: 50px !important;
    }
    
        
    /* å¾®ä¿¡æµè§ˆå™¨ç‰¹æ®Šä¼˜åŒ– */
    .weixin-browser .top-bar {
        padding: 6px 10px !important;
    }
    
    .weixin-browser.landscape-mode .top-bar {
        padding: 3px 6px !important;
    }
    
    .weixin-browser.landscape-mode .action-buttons .btn {
        font-size: 0.55rem !important;
        padding: 1px 3px !important;
    }
    
    .weixin-browser.mobile-landscape .top-bar {
        padding: 2px 4px !important;
        height: 35px !important;
    }
    
    .weixin-browser.mobile-landscape .action-buttons .btn {
        font-size: 0.5rem !important;
        padding: 1px 2px !important;
        height: 25px !important;
    }
</style>
<script>
// å¼ºåˆ¶åº”ç”¨ç§»åŠ¨ç«¯æ ·å¼
document.body.classList.add('mobile-device');

// æ£€æµ‹å¾®ä¿¡æµè§ˆå™¨
function isWeixinBrowser() {
    const ua = navigator.userAgent.toLowerCase();
    return ua.indexOf('micromessenger') !== -1;
}

if (isWeixinBrowser()) {
    document.body.classList.add('weixin-browser');
}

// ç°ä»£åŒ–æ¨ªç«–å±æ£€æµ‹å’Œå¤„ç† - é…åˆæ–°çš„è®¾å¤‡æ£€æµ‹é€»è¾‘
function handleOrientationChange() {
    // å»¶è¿Ÿæ‰§è¡Œç¡®ä¿å°ºå¯¸æ›´æ–°å®Œæˆ
    setTimeout(() => {
        console.log('ğŸ”„ å¼€å§‹å¤„ç†å±å¹•æ–¹å‘å˜åŒ–...');
        
        // ä½¿ç”¨å¤šç§æ–¹æ³•è¿›è¡Œæ›´å‡†ç¡®çš„æ¨ªç«–å±åˆ¤æ–­
        let isLandscape = false;
        let orientationMethod = 'unknown';
        
        // æ–¹æ³•1ï¼šä½¿ç”¨screen.orientation APIï¼ˆç°ä»£æµè§ˆå™¨ï¼‰
        if (screen.orientation && screen.orientation.angle !== undefined) {
            const angle = screen.orientation.angle;
            isLandscape = (angle === 90 || angle === 270);
            orientationMethod = 'screen.orientation';
        }
        // æ–¹æ³•2ï¼šä½¿ç”¨window.orientationï¼ˆiOS Safariç­‰ï¼‰
        else if (typeof window.orientation !== 'undefined') {
            const orientation = window.orientation;
            isLandscape = (orientation === 90 || orientation === -90);
            orientationMethod = 'window.orientation';
        }
        // æ–¹æ³•3ï¼šä½¿ç”¨CSSåª’ä½“æŸ¥è¯¢æ£€æµ‹
        else if (window.matchMedia) {
            isLandscape = window.matchMedia('(orientation: landscape)').matches;
            orientationMethod = 'matchMedia';
        }
        // æ–¹æ³•4ï¼šé™çº§æ–¹æ¡ˆ - ä½¿ç”¨å®½é«˜æ¯”åˆ¤æ–­ï¼ˆç§»åŠ¨è®¾å¤‡ç‰¹æ®Šå¤„ç†ï¼‰
        else {
            // ç§»åŠ¨è®¾å¤‡ï¼šæ›´ä¸¥æ ¼çš„æ¨ªå±åˆ¤æ–­
            const aspectRatio = window.innerWidth / window.innerHeight;
            isLandscape = (aspectRatio > 1.3) && (window.innerHeight <= 600);
            orientationMethod = 'aspect-ratio';
        }
        
        // æ¸…é™¤æ‰€æœ‰æ–¹å‘ç›¸å…³ç±»åï¼Œé¿å…å†²çª
        document.body.classList.remove('landscape-mode', 'portrait-mode', 'mobile-landscape');
        
        // åº”ç”¨æ–°çš„æ–¹å‘ç±»å
        if (isLandscape) {
            document.body.classList.add('landscape-mode');
            
            // ç§»åŠ¨è®¾å¤‡æ¨ªå±æ—¶çš„ç‰¹æ®Šå¤„ç†
            document.body.classList.add('mobile-landscape');
            console.log('ğŸ“±ğŸ”„ ç§»åŠ¨è®¾å¤‡æ¨ªå± - ä¿æŒç§»åŠ¨ç«¯UI');
        } else {
            document.body.classList.add('portrait-mode');
            console.log('ğŸ“±ğŸ“± ç§»åŠ¨è®¾å¤‡ç«–å±');
        }
        
        // è¾“å‡ºè¯¦ç»†è°ƒè¯•ä¿¡æ¯
        console.log('ğŸ”„ æ–¹å‘å˜åŒ–æ£€æµ‹å®Œæˆ:', {
            æ£€æµ‹æ–¹æ³•: orientationMethod,
            æ–¹å‘: isLandscape ? 'ğŸ”„ æ¨ªå±' : 'ğŸ“± ç«–å±',
            çª—å£å°ºå¯¸: `${window.innerWidth}x${window.innerHeight}`,
            å±å¹•å°ºå¯¸: `${screen.width}x${screen.height}`,
            å®½é«˜æ¯”: (window.innerWidth / window.innerHeight).toFixed(2),
            å½“å‰CSSç±»å: Array.from(document.body.classList).filter(cls => 
                cls.includes('mobile') || cls.includes('desktop') || cls.includes('landscape') || cls.includes('portrait')
            ),
            æœ€ç»ˆç»“æœ: `ğŸ“± ${isLandscape ? 'ğŸ”„' : 'ğŸ“±'}`
        });
    }, 150); // 150mså»¶è¿Ÿç¡®ä¿æ‰€æœ‰æ›´æ–°å®Œæˆ
}

// é¡µé¢åŠ è½½æ—¶è¿›è¡Œåˆå§‹æ£€æµ‹
handleOrientationChange();

// ç›‘å¬æ–¹å‘å˜åŒ–äº‹ä»¶ - ä½¿ç”¨å¤šç§äº‹ä»¶ç¡®ä¿æ£€æµ‹å‡†ç¡®æ€§

// 1. orientationchangeäº‹ä»¶ï¼ˆä¸»è¦ç”¨äºç§»åŠ¨è®¾å¤‡ï¼‰
if ('onorientationchange' in window) {
    window.addEventListener('orientationchange', function() {
        // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿orientationå€¼å·²æ›´æ–°
        setTimeout(handleOrientationChange, 150);
    }, false);
}

// 2. resizeäº‹ä»¶ï¼ˆé€šç”¨ï¼ŒåŒ…æ‹¬æ¡Œé¢å’Œç§»åŠ¨è®¾å¤‡ï¼‰
window.addEventListener('resize', function() {
    // å»¶è¿Ÿæ£€æµ‹æ–¹å‘å˜åŒ–
    setTimeout(handleOrientationChange, 100);
}, false);

// 3. screen.orientation changeäº‹ä»¶ï¼ˆç°ä»£æµè§ˆå™¨ï¼‰
if (screen.orientation && screen.orientation.addEventListener) {
    screen.orientation.addEventListener('change', function() {
        setTimeout(handleOrientationChange, 50);
    });
}

// 4. åª’ä½“æŸ¥è¯¢ç›‘å¬å™¨ï¼ˆCSS orientationå˜åŒ–ï¼‰
if (window.matchMedia) {
    const landscapeQuery = window.matchMedia('(orientation: landscape)');
    const portraitQuery = window.matchMedia('(orientation: portrait)');
    
    // ç°ä»£æµè§ˆå™¨ä½¿ç”¨addEventListener
    if (landscapeQuery.addEventListener) {
        landscapeQuery.addEventListener('change', handleOrientationChange);
        portraitQuery.addEventListener('change', handleOrientationChange);
    }
    // æ—§æµè§ˆå™¨ä½¿ç”¨addListener
    else if (landscapeQuery.addListener) {
        landscapeQuery.addListener(handleOrientationChange);
        portraitQuery.addListener(handleOrientationChange);
    }
}

// 5. é¡µé¢å¯è§æ€§å˜åŒ–æ—¶é‡æ–°æ£€æµ‹ï¼ˆä»åå°åˆ‡æ¢å›æ¥æ—¶ï¼‰
if (typeof document.visibilityState !== 'undefined') {
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            setTimeout(function() {
                detectMobileDevice();
                handleOrientationChange();
            }, 200);
        }
    });
}
        
        // è°ƒè¯•åŠŸèƒ½ï¼šåŒå‡»å·¦ä¸Šè§’å¯ä»¥é‡ç½®ç§»åŠ¨ç«¯æ£€æµ‹
        let clickCount = 0;
        document.querySelector('.back-btn').addEventListener('click', function(e) {
            clickCount++;
            if (clickCount === 1) {
                setTimeout(() => {
                    if (clickCount === 1) {
                        // å•å‡»æ­£å¸¸è·³è½¬
                        window.location.href = this.href;
                    }
                    clickCount = 0;
                }, 300);
            } else if (clickCount === 2) {
                // åŒå‡»é‡ç½®
                
                if (confirm('é‡ç½®ç§»åŠ¨ç«¯æ£€æµ‹è®¾ç½®ï¼Ÿ')) {
                    localStorage.removeItem('forceMobileMode');
                    document.body.classList.remove('mobile-device', 'weixin-browser', 'landscape-mode', 'portrait-mode');
                    location.reload();
                }
                clickCount = 0;
            }
        });
        
        // å¼ºåˆ¶é‡æ–°æ£€æµ‹å‡½æ•°ï¼ˆè°ƒè¯•ç”¨ï¼‰
        window.forceRedetectDevice = function() {
            console.log('=== å¼ºåˆ¶é‡æ–°æ£€æµ‹è®¾å¤‡å’Œæ–¹å‘ ===');
            detectMobileDevice();
            handleOrientationChange();
        };
        
        // é¡µé¢è·å¾—ç„¦ç‚¹æ—¶é‡æ–°æ£€æµ‹ï¼ˆä»å…¶ä»–åº”ç”¨åˆ‡æ¢å›æ¥ï¼‰
        window.addEventListener('focus', function() {
            setTimeout(function() {
                detectMobileDevice();
                handleOrientationChange();
                console.log('é¡µé¢è·å¾—ç„¦ç‚¹: é‡æ–°æ£€æµ‹è®¾å¤‡å’Œæ–¹å‘');
            }, 100);
        });
        
        // æ§åˆ¶å°è°ƒè¯•ä¿¡æ¯
         console.log('è®¾å¤‡æ£€æµ‹ä¿¡æ¯:', {
             userAgent: navigator.userAgent,
             isWeixin: isWeixinBrowser(),
             orientation: window.orientation,
             screenSize: `${window.innerWidth}x${window.innerHeight}`,
             forceMobileMode: localStorage.getItem('forceMobileMode'),
             touchSupport: 'ontouchstart' in window,
             pointerType: window.matchMedia('(pointer: coarse)').matches ? 'coarse' : 'fine',
             hoverSupport: window.matchMedia('(hover: hover)').matches
         });
         
         // æç¤ºç”¨æˆ·å¯ä»¥ä½¿ç”¨çš„è°ƒè¯•å‘½ä»¤
         console.log('è°ƒè¯•å‘½ä»¤: åœ¨æ§åˆ¶å°è¾“å…¥ forceRedetectDevice() å¯å¼ºåˆ¶é‡æ–°æ£€æµ‹è®¾å¤‡');

document.addEventListener('DOMContentLoaded', function () {
    // é¡µé¢åŠ è½½å®Œæˆåç«‹å³é‡æ–°æ£€æµ‹è®¾å¤‡å’Œæ–¹å‘
    setTimeout(function() {
        detectMobileDevice();
        handleOrientationChange();
        console.log('DOMContentLoaded: é‡æ–°æ£€æµ‹è®¾å¤‡å’Œæ–¹å‘');
    }, 50);
    
    const img = document.getElementById('original-image');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const toolBtns = document.querySelectorAll('.tool-btn');
    const undoBtn = document.getElementById('undo');
    const redoBtn = document.getElementById('redo');
    const clearBtn = document.getElementById('clear');
    const saveBtn = document.getElementById('save');
    const imageContainer = document.querySelector('.image-container');
    const toolDropdowns = document.querySelectorAll('.tool-settings-dropdown');

    let drawing = false;
    let currentPath = [];
    let objects = [];
    let redoStack = [];
    let currentTool = null;
    let settings = {
        pen: { thickness: 2, color: '#000000' },
        highlighter: { thickness: 10, color: '#FFFF00', alpha: 0.5 },
        wavy: { thickness: 2, height: 5, density: 4, color: '#000000' },
        eraser: { mode: 'partial', size: 10 }
    };
    
    // è§¦æ§æ‰‹åŠ¿å˜é‡
    let scale = 1;
    let translateX = 0;
    let translateY = 0;
    let lastTouchDistance = 0;
    let lastTouchCenter = { x: 0, y: 0 };
    let isGesturing = false;
    let touchStartTime = 0;

    img.onload = function () {
        // è®¾ç½®canvasçš„å®é™…åˆ†è¾¨ç‡
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        
        // è®¾ç½®canvasçš„æ˜¾ç¤ºå°ºå¯¸
        if (document.body.classList.contains('mobile-device')) {
            // ç§»åŠ¨ç«¯ï¼šcanvasåº”è¯¥è¦†ç›–æ•´ä¸ªå›¾ç‰‡æ˜¾ç¤ºåŒºåŸŸ
            const rect = img.getBoundingClientRect();
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            
            // ç¡®ä¿canvasä½ç½®æ­£ç¡®
            const containerRect = imageContainer.getBoundingClientRect();
            const imgRect = img.getBoundingClientRect();
            canvas.style.left = (imgRect.left - containerRect.left) + 'px';
            canvas.style.top = (imgRect.top - containerRect.top) + 'px';
        } else {
            // æ¡Œé¢ç«¯ï¼šä½¿ç”¨åŸæœ‰é€»è¾‘
            canvas.style.width = img.width + 'px';
            canvas.style.height = img.height + 'px';
        }
        
        redraw();
    };
    
    // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œé‡æ–°è°ƒæ•´canvaså°ºå¯¸
    window.addEventListener('resize', function() {
        if (document.body.classList.contains('mobile-device') && img.complete) {
            setTimeout(() => {
                const rect = img.getBoundingClientRect();
                canvas.style.width = rect.width + 'px';
                canvas.style.height = rect.height + 'px';
                
                const containerRect = imageContainer.getBoundingClientRect();
                const imgRect = img.getBoundingClientRect();
                canvas.style.left = (imgRect.left - containerRect.left) + 'px';
                canvas.style.top = (imgRect.top - containerRect.top) + 'px';
            }, 100);
        }
    });

    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);

    // è§¦æ§äº‹ä»¶å¤„ç†
    canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
    canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
    canvas.addEventListener('touchend', handleTouchEnd, { passive: false });
    
    // æ–°çš„å·¥å…·æŒ‰é’®äº‹ä»¶å¤„ç†
toolBtns.forEach(btn => {
    btn.addEventListener('click', function (e) {
        e.preventDefault();
        e.stopPropagation();
        const tool = this.dataset.tool;
        if (this.classList.contains('active')) {
            // å¦‚æœå·²æ¿€æ´»ï¼Œæ‰“å¼€ä¸‹æ‹‰èœå•
            const dropdown = this.nextElementSibling;
            if (dropdown && dropdown.classList.contains('dropdown-menu')) {
                dropdown.classList.toggle('show');
            }
        } else {
            // å¦‚æœæœªæ¿€æ´»ï¼Œæ¿€æ´»å®ƒå¹¶å…³é—­å…¶ä»–ä¸‹æ‹‰
            toolBtns.forEach(b => {
                b.classList.remove('active');
                const dd = b.nextElementSibling;
                if (dd && dd.classList.contains('dropdown-menu')) dd.classList.remove('show');
            });
            this.classList.add('active');
            currentTool = tool;
            console.log('é€‰æ‹©å·¥å…·:', tool);
        }
    });
});

// ç‚¹å‡»æ–‡æ¡£å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰
document.addEventListener('click', function(e) {
    if (!e.target.closest('.dropdown')) {
        document.querySelectorAll('.dropdown-menu.show').forEach(dd => dd.classList.remove('show'));
    }
});
    
    // å¤„ç†ä¸‹æ‹‰èœå•ä¸­çš„è®¾ç½®å˜æ›´
    toolDropdowns.forEach(dropdown => {
        const tool = dropdown.dataset.tool;
        
        // é¢œè‰²é€‰æ‹©
        const colorBtns = dropdown.querySelectorAll('.color-btn');
        colorBtns.forEach(colorBtn => {
            colorBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                // ç§»é™¤å…¶ä»–é¢œè‰²çš„æ¿€æ´»çŠ¶æ€
                colorBtns.forEach(btn => btn.classList.remove('active'));
                // æ¿€æ´»å½“å‰é¢œè‰²
                this.classList.add('active');
                
                const color = this.dataset.color;
                settings[tool].color = color;
                updatePreview(dropdown, tool);
                console.log(`${tool} é¢œè‰²è®¾ç½®ä¸º:`, color);
            });
        });
        
        // æ»‘å—è®¾ç½®
        const sliders = dropdown.querySelectorAll('input[type="range"]');
        sliders.forEach(slider => {
            slider.addEventListener('input', function() {
                const key = this.dataset.key;
                const value = parseInt(this.value);
                const valueSpan = this.parentNode.querySelector('.slider-value');
                
                if (valueSpan) {
                    valueSpan.textContent = value;
                }
                
                settings[tool][key] = value;
                updatePreview(dropdown, tool);
                console.log(`${tool} ${key} è®¾ç½®ä¸º:`, value);
            });
        });
        
        // æ©¡çš®æ“¦æ¨¡å¼é€‰æ‹©
        if (tool === 'eraser') {
            const modeRadios = dropdown.querySelectorAll('input[name="eraser-mode"]');
            modeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    settings.eraser.mode = this.value;
                    
                    // æ ¹æ®æ¨¡å¼æ˜¾ç¤º/éšè—å¤§å°è®¾ç½®
                    const sizeRow = dropdown.querySelector('#eraser-size-row');
                    if (sizeRow) {
                        sizeRow.style.display = this.value === 'partial' ? 'block' : 'none';
                    }
                    
                    updatePreview(dropdown, tool);
                    console.log('æ©¡çš®æ“¦æ¨¡å¼è®¾ç½®ä¸º:', this.value);
                });
            });
        }
        
        // åˆå§‹åŒ–é¢„è§ˆ
        updatePreview(dropdown, tool);
    });
    });

    undoBtn.addEventListener('click', function(e) {
        e.preventDefault();
        undo();
    });
    redoBtn.addEventListener('click', function(e) {
        e.preventDefault();
        redo();
    });
    clearBtn.addEventListener('click', function (e) {
        e.preventDefault();
        if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰åœˆç”»?')) {
            objects = [];
            redoStack = [];
            redraw();
        }
    });
    saveBtn.addEventListener('click', function (e) {
        e.preventDefault();
        e.stopPropagation();
        
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span class="btn-text">ä¿å­˜ä¸­...</span>';
        
        const data = canvas.toDataURL('image/png');
        fetch('{{ url_for("assignments.manual_annotate", submission_id=submission.id) }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: data })
        })
        .then(res => res.json())
        .then(data => {
            alert(data.message);
            console.log('ä¿å­˜æˆåŠŸ:', data);
        })
        .catch(error => {
            console.error('ä¿å­˜å¤±è´¥:', error);
            alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
        })
        .finally(() => {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save"></i> <span class="btn-text">ä¿å­˜</span>';
        });
    });

    // è®¾å¤‡æ¨¡å¼åˆ‡æ¢æŒ‰é’®äº‹ä»¶å¤„ç†å™¨
    const deviceToggleBtn = document.getElementById('device-toggle');
    if (deviceToggleBtn) {
        deviceToggleBtn.addEventListener('click', function() {
            console.log('è®¾å¤‡æ¨¡å¼åˆ‡æ¢æŒ‰é’®è¢«ç‚¹å‡»');
            
            // è·å–å½“å‰å¼ºåˆ¶æ¨¡å¼çŠ¶æ€
            const currentForceMobile = localStorage.getItem('forceMobileMode');
            const currentForceDesktop = localStorage.getItem('forceDesktopMode');
            
            // åˆ‡æ¢é€»è¾‘ï¼šç§»åŠ¨ç«¯ -> æ¡Œé¢ç«¯ -> è‡ªåŠ¨æ£€æµ‹ -> ç§»åŠ¨ç«¯
            if (currentForceMobile === 'true') {
                // å½“å‰å¼ºåˆ¶ç§»åŠ¨æ¨¡å¼ï¼Œåˆ‡æ¢åˆ°å¼ºåˆ¶æ¡Œé¢æ¨¡å¼
                localStorage.removeItem('forceMobileMode');
                localStorage.setItem('forceDesktopMode', 'true');
                console.log('åˆ‡æ¢åˆ°å¼ºåˆ¶æ¡Œé¢æ¨¡å¼');
            } else if (currentForceDesktop === 'true') {
                // å½“å‰å¼ºåˆ¶æ¡Œé¢æ¨¡å¼ï¼Œåˆ‡æ¢åˆ°è‡ªåŠ¨æ£€æµ‹
                localStorage.removeItem('forceDesktopMode');
                console.log('åˆ‡æ¢åˆ°è‡ªåŠ¨æ£€æµ‹æ¨¡å¼');
            } else {
                // å½“å‰è‡ªåŠ¨æ£€æµ‹ï¼Œåˆ‡æ¢åˆ°å¼ºåˆ¶ç§»åŠ¨æ¨¡å¼
                localStorage.setItem('forceMobileMode', 'true');
                console.log('åˆ‡æ¢åˆ°å¼ºåˆ¶ç§»åŠ¨æ¨¡å¼');
            }
            
            // é‡æ–°æ£€æµ‹è®¾å¤‡å¹¶æ›´æ–°UI
            detectMobileDevice();
            handleOrientationChange();
            
            // æ›´æ–°æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
            updateDeviceToggleButton();
            
            // æç¤ºç”¨æˆ·æ¨¡å¼å·²åˆ‡æ¢
            const newMode = localStorage.getItem('forceMobileMode') === 'true' ? 'ç§»åŠ¨ç«¯æ¨¡å¼' : 
                           localStorage.getItem('forceDesktopMode') === 'true' ? 'æ¡Œé¢ç«¯æ¨¡å¼' : 'è‡ªåŠ¨æ£€æµ‹æ¨¡å¼';
            console.log(`å·²åˆ‡æ¢åˆ°: ${newMode}`);
        });
    }

    // æ›´æ–°è®¾å¤‡åˆ‡æ¢æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€çš„å‡½æ•°
    function updateDeviceToggleButton() {
        const deviceToggleBtn = document.getElementById('device-toggle');
        if (!deviceToggleBtn) return;
        
        const icon = deviceToggleBtn.querySelector('i');
        const text = deviceToggleBtn.querySelector('.device-mode-text');
        
        const forceMobile = localStorage.getItem('forceMobileMode') === 'true';
        const forceDesktop = localStorage.getItem('forceDesktopMode') === 'true';
        
        if (forceMobile) {
            icon.className = 'fas fa-mobile-alt';
            text.textContent = 'ç§»åŠ¨ç«¯';
            deviceToggleBtn.className = 'btn btn-outline-secondary mobile-mode';
            deviceToggleBtn.title = 'å½“å‰ï¼šå¼ºåˆ¶ç§»åŠ¨ç«¯æ¨¡å¼';
        } else if (forceDesktop) {
            icon.className = 'fas fa-desktop';
            text.textContent = 'æ¡Œé¢ç«¯';
            deviceToggleBtn.className = 'btn btn-outline-secondary desktop-mode';
            deviceToggleBtn.title = 'å½“å‰ï¼šå¼ºåˆ¶æ¡Œé¢ç«¯æ¨¡å¼';
        } else {
            icon.className = 'fas fa-sync-alt';
            text.textContent = 'è‡ªåŠ¨';
            deviceToggleBtn.className = 'btn btn-outline-secondary auto-mode';
            deviceToggleBtn.title = 'å½“å‰ï¼šè‡ªåŠ¨æ£€æµ‹æ¨¡å¼';
        }
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
    updateDeviceToggleButton();

    function showSettingsDropdown(btn, tool) {
        const dropdown = document.createElement('div');
        dropdown.className = 'settings-dropdown';
        const toolSettings = settings[tool];

        if (['pen', 'highlighter', 'wavy'].includes(tool)) {
            const colors = tool === 'highlighter' ? ['#FFFF00', '#FF69B4', '#00FF00', '#0000FF'] : ['#FF0000', '#00FF00', '#0000FF', '#000000'];
            
            // é¢œè‰²é€‰æ‹©è¡Œ
            dropdown.innerHTML += '<div class="settings-row">';
            dropdown.innerHTML += '<div class="settings-label"><i class="fas fa-palette"></i>é¢œè‰²</div>';
            dropdown.innerHTML += '<div class="color-picker">';
            colors.forEach(c => {
                const active = toolSettings.color === c ? ' active' : '';
                dropdown.innerHTML += `<button class="color-btn${active}" style="background-color: ${c};" data-color="${c}"></button>`;
            });
            dropdown.innerHTML += '</div></div>';

            // ç²—ç»†è®¾ç½®è¡Œ
            if (tool === 'pen' || tool === 'highlighter' || tool === 'wavy') {
                dropdown.innerHTML += '<div class="settings-row">';
                dropdown.innerHTML += '<div class="settings-label"><i class="fas fa-pen"></i>ç²—ç»†</div>';
                dropdown.innerHTML += '<div class="settings-slider">';
                dropdown.innerHTML += `<input type="range" min="1" max="20" value="${toolSettings.thickness}" data-key="thickness">`;
                dropdown.innerHTML += '</div>';
                dropdown.innerHTML += `<div class="slider-value">${toolSettings.thickness}</div>`;
                dropdown.innerHTML += '</div>';
            }
            
            // æ³¢æµªçº¿ç‰¹æ®Šè®¾ç½®
            if (tool === 'wavy') {
                dropdown.innerHTML += '<div class="settings-row">';
                dropdown.innerHTML += '<div class="settings-label"><i class="fas fa-arrows-alt-v"></i>é«˜åº¦</div>';
                dropdown.innerHTML += '<div class="settings-slider">';
                dropdown.innerHTML += `<input type="range" min="1" max="20" value="${toolSettings.height}" data-key="height">`;
                dropdown.innerHTML += '</div>';
                dropdown.innerHTML += `<div class="slider-value">${toolSettings.height}</div>`;
                dropdown.innerHTML += '</div>';
                
                dropdown.innerHTML += '<div class="settings-row">';
                dropdown.innerHTML += '<div class="settings-label"><i class="fas fa-compress-alt"></i>å¯†åº¦</div>';
                dropdown.innerHTML += '<div class="settings-slider">';
                dropdown.innerHTML += `<input type="range" min="1" max="10" value="${toolSettings.density}" data-key="density">`;
                dropdown.innerHTML += '</div>';
                dropdown.innerHTML += `<div class="slider-value">${toolSettings.density}</div>`;
                dropdown.innerHTML += '</div>';
            }
            
            // é¢„è§ˆ
            dropdown.innerHTML += '<canvas width="100%" height="40" class="mt-2 border" data-preview="true" style="border-radius: 8px;"></canvas>';
        } else if (tool === 'eraser') {
            // æ¨¡å¼é€‰æ‹©è¡Œ
            dropdown.innerHTML += '<div class="settings-row">';
            dropdown.innerHTML += '<div class="settings-label"><i class="fas fa-eraser"></i>æ¨¡å¼</div>';
            dropdown.innerHTML += '<div class="mode-buttons">';
            dropdown.innerHTML += `<button class="btn btn-outline-primary ${toolSettings.mode === 'partial' ? 'active' : ''}" data-mode="partial">éƒ¨åˆ†</button>`;
            dropdown.innerHTML += `<button class="btn btn-outline-primary ${toolSettings.mode === 'object' ? 'active' : ''}" data-mode="object">å¯¹è±¡</button>`;
            dropdown.innerHTML += '</div></div>';
            
            // å¤§å°è®¾ç½®è¡Œï¼ˆä»…éƒ¨åˆ†æ“¦é™¤æ¨¡å¼ï¼‰
            if (toolSettings.mode === 'partial') {
                dropdown.innerHTML += '<div class="settings-row" id="size-slider-row">';
                dropdown.innerHTML += '<div class="settings-label"><i class="fas fa-expand"></i>å¤§å°</div>';
                dropdown.innerHTML += '<div class="settings-slider">';
                dropdown.innerHTML += `<input type="range" min="5" max="50" value="${toolSettings.size}" data-key="size">`;
                dropdown.innerHTML += '</div>';
                dropdown.innerHTML += `<div class="slider-value">${toolSettings.size}</div>`;
                dropdown.innerHTML += '</div>';
            }
            
            // é¢„è§ˆ
            dropdown.innerHTML += '<canvas width="100%" height="40" class="mt-2 border" data-preview="true" style="border-radius: 8px;"></canvas>';
        }

        btn.appendChild(dropdown);
        dropdown.classList.add('visible');

        // äº‹ä»¶å§”æ‰˜
        dropdown.querySelectorAll('.color-btn').forEach(b => b.addEventListener('click', () => updateSetting(tool, 'color', b.dataset.color)));
        const ranges = dropdown.querySelectorAll('input[type="range"]');
        ranges.forEach(r => {
            r.addEventListener('input', (e) => {
                updateSetting(tool, e.target.dataset.key, e.target.value);
                // æ›´æ–°æ˜¾ç¤ºçš„æ•°å€¼
                const valueDisplay = e.target.parentElement.nextElementSibling;
                if (valueDisplay && valueDisplay.classList.contains('slider-value')) {
                    valueDisplay.textContent = e.target.value;
                }
            });
        });
        const modeButtons = dropdown.querySelectorAll('.mode-buttons button');
        modeButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                modeButtons.forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                const newMode = e.target.dataset.mode;
                updateSetting(tool, 'mode', newMode);
                // Toggle size slider
                const sizeSliderRow = dropdown.querySelector('#size-slider-row');
                if (newMode === 'partial') {
                    if (!sizeSliderRow) {
                        const newSliderRow = `<div class="settings-row" id="size-slider-row">
                            <div class="settings-label"><i class="fas fa-expand"></i>å¤§å°</div>
                            <div class="settings-slider">
                                <input type="range" min="5" max="50" value="${settings[tool].size}" data-key="size">
                            </div>
                            <div class="slider-value">${settings[tool].size}</div>
                        </div>`;
                        dropdown.insertBefore(document.createRange().createContextualFragment(newSliderRow), dropdown.querySelector('[data-preview="true"]'));
                        const newRange = dropdown.querySelector('input[data-key="size"]');
                        newRange.addEventListener('input', (ev) => {
                            updateSetting(tool, 'size', ev.target.value);
                            const valueDisplay = ev.target.parentElement.nextElementSibling;
                            if (valueDisplay && valueDisplay.classList.contains('slider-value')) {
                                valueDisplay.textContent = ev.target.value;
                            }
                        });
                    }
                } else if (sizeSliderRow) {
                    sizeSliderRow.remove();
                }
                updatePreview(dropdown, tool);
            });
        });
        updatePreview(dropdown, tool);
    }

    function updateSetting(tool, key, value) {
        settings[tool][key] = key === 'color' || key === 'mode' ? value : parseInt(value);
        const dropdown = document.querySelector('.settings-dropdown');
        if (dropdown) updatePreview(dropdown, tool);
    }

    function updatePreview(dropdown, tool) {
        const previewCanvas = dropdown.querySelector('.preview-canvas');
        if (!previewCanvas) return;
        
        const pCtx = previewCanvas.getContext('2d');
        pCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
        const toolSettings = settings[tool];
        
        // è®¾ç½®ç”»ç¬”æ ·å¼
        pCtx.strokeStyle = toolSettings.color || '#000000';
        pCtx.lineWidth = toolSettings.thickness || 2;
        pCtx.globalAlpha = tool === 'highlighter' ? (toolSettings.alpha || 0.5) : 1;
        pCtx.lineCap = 'round';
        pCtx.lineJoin = 'round';

        if (tool === 'wavy') {
            // ç»˜åˆ¶æ³¢æµªçº¿é¢„è§ˆ
            pCtx.beginPath();
            const startX = 10;
            const endX = 190;
            const centerY = 20;
            const dx = endX - startX;
            const steps = Math.floor(dx / 3);
            
            pCtx.moveTo(startX, centerY);
            for (let i = 1; i <= steps; i++) {
                const t = i / steps;
                const x = startX + t * dx;
                const y = centerY + Math.sin(t * Math.PI * (toolSettings.density || 4)) * (toolSettings.height || 5);
                pCtx.lineTo(x, y);
            }
            pCtx.stroke();
        } else if (tool === 'eraser') {
            if (toolSettings.mode === 'partial') {
                // ç»˜åˆ¶åœ†å½¢æ©¡çš®æ“¦é¢„è§ˆ
                pCtx.fillStyle = 'rgba(255, 0, 0, 0.3)';
                pCtx.strokeStyle = '#FF0000';
                pCtx.lineWidth = 2;
                pCtx.beginPath();
                pCtx.arc(100, 20, (toolSettings.size || 10) / 2, 0, Math.PI * 2);
                pCtx.fill();
                pCtx.stroke();
            } else {
                // å¯¹è±¡æ“¦é™¤æ¨¡å¼æ˜¾ç¤ºåå­—æ ‡è®°
                pCtx.strokeStyle = '#FF0000';
                pCtx.lineWidth = 2;
                pCtx.beginPath();
                pCtx.moveTo(85, 20); pCtx.lineTo(115, 20);
                pCtx.moveTo(100, 5); pCtx.lineTo(100, 35);
                pCtx.stroke();
                
                // æ·»åŠ æ–‡å­—è¯´æ˜
                pCtx.fillStyle = '#666';
                pCtx.font = '12px Arial';
                pCtx.textAlign = 'center';
                pCtx.fillText('ç‚¹å‡»å¯¹è±¡åˆ é™¤', 100, 35);
            }
        } else {
            // ç»˜åˆ¶ç›´çº¿é¢„è§ˆï¼ˆåœ†ç ç¬”ã€è§å…‰ç¬”ï¼‰
            pCtx.beginPath();
            pCtx.moveTo(10, 20);
            pCtx.lineTo(190, 20);
            pCtx.stroke();
        }
        
        pCtx.globalAlpha = 1;
    }

    function startDrawing(e) {
        if (!currentTool) return;
        if (currentTool === 'eraser') {
            const mode = settings.eraser.mode;
            if (mode === 'partial') {
                drawing = true;
                currentPath = [getMousePos(e)];
                erase(e);
                return;
            } else if (mode === 'object') {
                erase(e);
                return;
            }
        }
        drawing = true;
        currentPath = [getMousePos(e)];
    }

    function draw(e) {
        if (!drawing) return;
        const pos = getMousePos(e);
        currentPath.push(pos);
        if (currentTool === 'eraser' && settings.eraser.mode === 'partial') {
            erase(e);
        } else {
            redraw();
        }
    }

    function stopDrawing() {
        if (drawing) {
            drawing = false;
            if (currentTool !== 'eraser') {
            const obj = { type: currentTool, path: currentPath, ...settings[currentTool] };
            objects.push(obj);
            redoStack = [];
            }
            redraw();
            currentPath = [];
        }
    }

    function erase(e) {
        const pos = getMousePos(e);
        const mode = settings.eraser.mode;
        if (mode === 'partial') {
            ctx.globalCompositeOperation = 'destination-out';
            ctx.beginPath();
            ctx.arc(pos.x, pos.y, settings.eraser.size / 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.globalCompositeOperation = 'source-over';
        } else if (mode === 'object') {
            for (let i = objects.length - 1; i >= 0; i--) {
                if (isPointNearObject(objects[i], pos)) {
                    redoStack.push(objects.splice(i, 1)[0]);
                    redraw();
                    break;
                }
            }
        }
    }

    function isPointNearObject(obj, pos) {
        // ç®€å•è·ç¦»æ£€æŸ¥
        for (let i = 0; i < obj.path.length - 1; i++) {
            const p1 = obj.path[i];
            const p2 = obj.path[i+1];
            const dist = distanceToSegment(pos, p1, p2);
            if (dist < 10) return true;
        }
        return false;
    }

    function distanceToSegment(point, p1, p2) {
        const dx = p2.x - p1.x;
        const dy = p2.y - p1.y;
        const len = dx*dx + dy*dy;
        let t = ((point.x - p1.x) * dx + (point.y - p1.y) * dy) / len;
        t = Math.max(0, Math.min(1, t));
        const proj = { x: p1.x + t * dx, y: p1.y + t * dy };
        return Math.sqrt((point.x - proj.x)**2 + (point.y - proj.y)**2);
    }

    function redraw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        objects.forEach(obj => {
            ctx.strokeStyle = obj.color;
            ctx.lineWidth = obj.thickness;
            ctx.globalAlpha = obj.alpha || 1;
            ctx.beginPath();
            if (obj.path && obj.path.length > 0) {
            ctx.moveTo(obj.path[0].x, obj.path[0].y);
            if (obj.type === 'wavy') {
                const start = obj.path[0];
                const end = obj.path[obj.path.length - 1];
                const dx = end.x - start.x;
                const dy = end.y - start.y;
                const len = Math.sqrt(dx*dx + dy*dy);
                const steps = len / 5;
                for (let i = 1; i <= steps; i++) {
                    const t = i / steps;
                    const x = start.x + t * dx;
                    const y = start.y + t * dy + Math.sin(t * Math.PI * obj.density) * obj.height;
                    ctx.lineTo(x, y);
                }
            } else {
                obj.path.forEach(p => ctx.lineTo(p.x, p.y));
                }
            }
            ctx.stroke();
            ctx.globalAlpha = 1;
        });
        if (drawing && currentPath.length > 1 && currentTool !== 'eraser') {
            ctx.strokeStyle = settings[currentTool].color;
            ctx.lineWidth = settings[currentTool].thickness;
            ctx.globalAlpha = settings[currentTool].alpha || 1;
            ctx.beginPath();
            ctx.moveTo(currentPath[0].x, currentPath[0].y);
            currentPath.forEach(p => ctx.lineTo(p.x, p.y));
            ctx.stroke();
            ctx.globalAlpha = 1;
        }
    }

    function getMousePos(e) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        return { x: (e.clientX - rect.left) * scaleX, y: (e.clientY - rect.top) * scaleY };
    }

    function undo() {
        if (objects.length > 0) {
            redoStack.push(objects.pop());
            redraw();
        }
    }

    function redo() {
        if (redoStack.length > 0) {
            objects.push(redoStack.pop());
            redraw();
        }
    }
    
    // è§¦æ§æ‰‹åŠ¿å¤„ç†å‡½æ•°
    function handleTouchStart(e) {
        e.preventDefault();
        touchStartTime = Date.now();
        
        if (e.touches.length === 1) {
            // å•æŒ‡è§¦æ§ - ç»˜ç”»
            isGesturing = false;
            if (currentTool) {
                startDrawing(e.touches[0]);
            }
        } else if (e.touches.length === 2) {
            // åŒæŒ‡è§¦æ§ - æ‰‹åŠ¿æ“ä½œ
            isGesturing = true;
            if (drawing) {
                stopDrawing();
            }
            
            const touch1 = e.touches[0];
            const touch2 = e.touches[1];
            
            lastTouchDistance = getTouchDistance(touch1, touch2);
            lastTouchCenter = getTouchCenter(touch1, touch2);
        }
    }
    
    function handleTouchMove(e) {
        e.preventDefault();
        
        if (e.touches.length === 1 && !isGesturing) {
            // å•æŒ‡ç§»åŠ¨ - ç»˜ç”»
            if (currentTool && drawing) {
                draw(e.touches[0]);
            }
        } else if (e.touches.length === 2) {
            // åŒæŒ‡ç§»åŠ¨ - ç¼©æ”¾å’Œå¹³ç§»
            isGesturing = true;
            
            const touch1 = e.touches[0];
            const touch2 = e.touches[1];
            
            const currentDistance = getTouchDistance(touch1, touch2);
            const currentCenter = getTouchCenter(touch1, touch2);
            
            // ç¼©æ”¾
            if (lastTouchDistance > 0) {
                const scaleChange = currentDistance / lastTouchDistance;
                const newScale = scale * scaleChange;
                
                // é™åˆ¶ç¼©æ”¾èŒƒå›´
                if (newScale >= 0.5 && newScale <= 3) {
                    scale = newScale;
                }
            }
            
            // å¹³ç§»
            const deltaX = currentCenter.x - lastTouchCenter.x;
            const deltaY = currentCenter.y - lastTouchCenter.y;
            translateX += deltaX;
            translateY += deltaY;
            
            // åº”ç”¨å˜æ¢
            applyTransform();
            
            lastTouchDistance = currentDistance;
            lastTouchCenter = currentCenter;
        }
    }
    
    function handleTouchEnd(e) {
        e.preventDefault();
        
        if (e.touches.length === 0) {
            // æ‰€æœ‰æ‰‹æŒ‡ç¦»å¼€
            if (!isGesturing && drawing) {
                stopDrawing();
            }
            isGesturing = false;
            lastTouchDistance = 0;
        } else if (e.touches.length === 1 && isGesturing) {
            // ä»åŒæŒ‡å˜ä¸ºå•æŒ‡
            isGesturing = false;
            lastTouchDistance = 0;
        }
    }
    
    function getTouchDistance(touch1, touch2) {
        const dx = touch1.clientX - touch2.clientX;
        const dy = touch1.clientY - touch2.clientY;
        return Math.sqrt(dx * dx + dy * dy);
    }
    
    function getTouchCenter(touch1, touch2) {
        return {
            x: (touch1.clientX + touch2.clientX) / 2,
            y: (touch1.clientY + touch2.clientY) / 2
        };
    }
    
    function applyTransform() {
        const transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
        img.style.transform = `translate(-50%, -50%) ${transform}`;
        canvas.style.transform = `translate(-50%, -50%) ${transform}`;
    }
    
    // é‡ç½®å˜æ¢
    function resetTransform() {
        scale = 1;
        translateX = 0;
        translateY = 0;
        applyTransform();
    }
    
    // åŒå‡»é‡ç½®ç¼©æ”¾ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
    let lastTapTime = 0;
    canvas.addEventListener('touchend', function(e) {
        if (e.touches.length === 0) {
            const currentTime = Date.now();
            if (currentTime - lastTapTime < 300) {
                // åŒå‡»æ£€æµ‹
                resetTransform();
            }
            lastTapTime = currentTime;
        }
    });
});
</script>
{% endblock %}