{% extends "base.html" %}

{% block head %}
{{ super() }}
<style>
    /* Base styles for the accordion item border */
    .accordion-item {
        border-left: 5px solid #d9d9d9; /* Default to not-submitted */
        transition: border-color 0.3s ease;
    }
    /* Status-specific border colors */
    .accordion-item.status-submitted { border-left-color: #1890ff; }
    .accordion-item.status-processing { border-left-color: #faad14; }

    /* The button/header itself */
    .accordion-button {
        /* Reverted from Grid to Flex to fix layout issues */
        gap: 1rem;
        align-items: center;
        width: 100%;
        transition: background-color 0.3s ease;
    }

    /* Override Bootstrap's focus shadow and expanded text color */
    .accordion-button:focus { box-shadow: none; }
    .accordion-button:not(.collapsed) {
        color: var(--bs-body-color);
        box-shadow: none;
    }
    
    /* Ensure our status colors have high priority, even when expanded */
    .accordion-item.status-submitted .accordion-button,
    .accordion-item.status-submitted .accordion-button.collapsed { background-color: #e6f7ff; }
    .accordion-item.status-processing .accordion-button,
    .accordion-item.status-processing .accordion-button.collapsed { background-color: #fffbe6; }
    .accordion-item.status-not-submitted .accordion-button,
    .accordion-item.status-not-submitted .accordion-button.collapsed { background-color: #fafafa; }

    .student-info { 
        text-align: left; 
        flex-grow: 1; /* Allow this to take up available space */
    }
    .submission-summary {
        text-align: right;
        font-size: 0.9rem;
        color: #595959;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 1.5rem;
        flex-shrink: 0; /* Prevent summary from shrinking */
    }
    /* .accordion-button::after is now handled by default Bootstrap flex properties */

    /* Hide the chevron for non-expandable headers */
    .accordion-button.non-expandable::after { display: none; }
</style>
{% endblock %}


{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-1">{{ assignment.title }} ({{ assignment.grading_standard.total_score|round(0) }}分)</h1>
            <p class="text-muted">学生提交情况</p>
        </div>
        <a href="{{ url_for('assignments.assignment_detail', assignment_id=assignment.id) }}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-chevron-left"></i> 返回作业详情
        </a>
    </div>

    <!-- Summary and Controls -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <h5 class="card-title">提交概览</h5>
                    <canvas id="submissionChart" style="max-height: 150px;"></canvas>
                </div>
                <div class="col-md-8">
                    <div class="d-flex justify-content-end align-items-center">
                        <span class="me-3">排序方式:</span>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="sortMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                {% if sort_by == 'name_asc' %}姓名 (A-Z)
                                {% elif sort_by == 'name_desc' %}姓名 (Z-A)
                                {% elif sort_by == 'student_number_asc' %}按班级名册排序 (升序)
                                {% elif sort_by == 'student_number_desc' %}按班级名册排序 (降序)
                                {% elif sort_by == 'latest_score_desc' %}分数 (高-低)
                                {% elif sort_by == 'latest_score_asc' %}分数 (低-高)
                                {% elif sort_by == 'submission_count_desc' %}提交次数 (多-少)
                                {% elif sort_by == 'submission_count_asc' %}提交次数 (少-多)
                                {% else %}选择排序
                                {% endif %}
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="sortMenuButton">
                                <li><a class="dropdown-item" href="?sort_by=name_asc">姓名 (A-Z)</a></li>
                                <li><a class="dropdown-item" href="?sort_by=name_desc">姓名 (Z-A)</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="?sort_by=student_number_asc">按班级名册排序 (升序)</a></li>
                                <li><a class="dropdown-item" href="?sort_by=student_number_desc">按班级名册排序 (降序)</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="?sort_by=latest_score_desc">分数 (高-低)</a></li>
                                <li><a class="dropdown-item" href="?sort_by=latest_score_asc">分数 (低-高)</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="?sort_by=submission_count_desc">提交次数 (多-少)</a></li>
                                <li><a class="dropdown-item" href="?sort_by=submission_count_asc">提交次数 (少-多)</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="accordion" id="studentsAccordion">
        {% for student in submissions %}
            <div class="accordion-item mb-2 status-{{ student.status_key }}">
                <h2 class="accordion-header" id="heading-{{ student.student_id }}">
                    
                    {# CASE: Student has NOT submitted -> Static, non-interactive header #}
                    {% if student.submission_count == 0 %}
                        <div class="accordion-button non-expandable collapsed">
                            <div class="student-info">
                                <strong class="fs-6">{{ student.student_name }}</strong>
                            </div>
                            <div class="submission-summary">
                                <span class="text-muted"><i class="fas fa-times-circle me-1"></i>未提交</span>
                            </div>
                        </div>

                    {# CASE: Student has submitted (1 or more times) -> Collapsible Button, potentially expanded #}
                    {% else %}
                        <button class="accordion-button {% if not student.is_processing %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ student.student_id }}" aria-expanded="{{ 'true' if student.is_processing else 'false' }}" aria-controls="collapse-{{ student.student_id }}">
                            <div class="student-info">
                                <strong class="fs-6">{{ student.student_name }}</strong>
                            </div>
                            
                            <div class="submission-summary">
                                {% if student.is_processing %}
                                    <span class="badge bg-warning text-dark"><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 处理中...</span>
                                {% else %}
                                    <span class="text-success"><i class="fas fa-check-circle me-1"></i>已提交</span>
                                    {% if student.latest_score is not none %}
                                        <span class="badge bg-primary">分数: {{ "%.1f"|format(student.latest_score) }} / {{ assignment.grading_standard.total_score|round(0) }}</span>
                                    {% endif %}
                                    <span class="badge rounded-pill bg-info text-dark">{{ student.submission_count }} 次</span>
                                {% endif %}
                            </div>
                        </button>
                    {% endif %}
                </h2>

                {# Details for any submitted student (1 or more), potentially shown by default #}
                {% if student.submission_count > 0 %}
                    <div id="collapse-{{ student.student_id }}" class="accordion-collapse collapse {% if student.is_processing %}show{% endif %}" aria-labelledby="heading-{{ student.student_id }}">
                        <div class="accordion-body">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr class="table-light">
                                        <th style="width: 20%;">提交时间</th>
                                        <th style="width: 40%;">状态</th>
                                        <th style="width: 20%;">分数</th>
                                        <th style="width: 20%;">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for submission in student.submissions %}
                                        {% include 'assignments/_submission_row.html' %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endif %}
            </div>
        {% else %}
            <div class="alert alert-info" role="alert">
                该作业还没有任何学生提交或分配。
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Chart
    const ctx = document.getElementById('submissionChart');
    if (ctx) {
        try {
            const summaryData = JSON.parse('{{ summary_counts_json | safe }}');
            // Ensure data is valid and there's something to show before creating the chart
            if (summaryData && (summaryData.submitted > 0 || summaryData.not_submitted > 0 || summaryData.processing > 0)) {
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: [`已提交 (${summaryData.submitted})`, `未提交 (${summaryData.not_submitted})`, `处理中 (${summaryData.processing})`],
                        datasets: [{
                            label: '学生人数',
                            data: [summaryData.submitted, summaryData.not_submitted, summaryData.processing],
                            backgroundColor: [
                                '#e6f7ff',
                                '#fafafa',
                                '#fffbe6'
                            ],
                            borderColor: [
                                '#1890ff',
                                '#d9d9d9',
                                '#faad14'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                            }
                        }
                    }
                });
            } else {
                // Optional: Display a message if there's no data
                ctx.parentElement.innerHTML = '<div class="text-center text-muted p-4">暂无提交数据</div>';
            }
        } catch (e) {
            console.error("无法解析提交概览数据:", e);
            ctx.parentElement.innerHTML = '<div class="text-center text-danger p-4">无法加载图表</div>';
        }
    }

    // Polling logic
    const essaysToPoll = new Map();
    function findEssaysToPoll() {
        essaysToPoll.clear();
        const progressContainers = document.querySelectorAll('.progress-container');
        progressContainers.forEach(container => {
            const essayId = container.dataset.essayId;
            if (essayId) {
                essaysToPoll.set(essayId, container);
            }
        });
    }

    function updateUI(statusData) {
        let hasActiveTasks = false;
        for (const essayId in statusData) {
            const data = statusData[essayId];
            
            if (data.is_finished) {
                window.location.reload();
            } else {
                hasActiveTasks = true;
                const container = document.querySelector(`.progress-container[data-essay-id='${essayId}']`);
                if (!container) continue;

                const progressBar = container.querySelector('.progress-bar');
                const progressText = container.querySelector('.progress-text');
                if (progressBar) {
                    progressBar.style.width = data.progress + '%';
                    progressBar.setAttribute('aria-valuenow', data.progress);
                }
                if (progressText) {
                    progressText.textContent = data.text;
                }
            }
        }
        return hasActiveTasks;
    }
    
    async function pollStatuses() {
        findEssaysToPoll();
        if (essaysToPoll.size === 0) return;

        const ids = Array.from(essaysToPoll.keys()).join(',');
        try {
            const response = await fetch(`/assignments/api/essays/status?ids=${ids}`);
            if (response.ok) {
                const data = await response.json();
                const stillProcessing = updateUI(data);
                if (stillProcessing) {
                    setTimeout(pollStatuses, 5000); // Continue polling
                }
            } else {
                console.error('Failed to fetch submission statuses:', response.statusText);
                setTimeout(pollStatuses, 15000);
            }
        } catch (error) {
            console.error('Error polling submission statuses:', error);
            setTimeout(pollStatuses, 15000);
        }
    }

    pollStatuses();
});
</script>
{% endblock %} 