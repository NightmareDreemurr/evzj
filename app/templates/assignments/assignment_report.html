{% extends "base.html" %}

{% block title %}作业报告 - {{ assignment.title }}{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.chart-container {
    position: relative;
    height: 400px;
    margin-bottom: 20px;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.stat-number {
    font-size: 2.5rem;
    font-weight: bold;
}

.stat-label {
    font-size: 1rem;
    opacity: 0.9;
}

.problem-item {
    background: #f8f9fa;
    border-left: 4px solid #dc3545;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 5px;
}

.strength-item {
    background: #f8f9fa;
    border-left: 4px solid #28a745;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 5px;
}

.example-text {
    background: #e9ecef;
    padding: 10px;
    border-radius: 5px;
    font-style: italic;
    margin: 10px 0;
}

.dimension-score {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
    margin-bottom: 10px;
}

.score-bar {
    width: 60%;
    height: 20px;
    background: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
}

.score-fill {
    height: 100%;
    background: linear-gradient(90deg, #28a745, #20c997);
    transition: width 0.3s ease;
}

/* 移动端优化样式 */
@media (max-width: 768px) {
    /* 容器和间距优化 */
    .container-fluid {
        padding-left: 10px;
        padding-right: 10px;
    }
    
    /* 统计卡片优化 */
    .stat-card {
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .stat-number {
        font-size: 2rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
    }
    
    /* 图表容器优化 */
    .chart-container {
        height: 300px;
        margin-bottom: 15px;
    }
    
    /* 卡片优化 */
    .card {
        margin-bottom: 15px;
    }
    
    .card-header {
        padding: 10px 15px;
    }
    
    .card-body {
        padding: 15px;
    }
    
    .card-title {
        font-size: 1.1rem;
        margin-bottom: 0;
    }
    
    /* 按钮组优化 */
    .card-tools {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .card-tools .btn {
        font-size: 0.8rem;
        padding: 5px 10px;
    }
    
    /* 问题和优势项目优化 */
    .problem-item,
    .strength-item {
        padding: 12px;
        margin-bottom: 8px;
    }
    
    .problem-item h6,
    .strength-item h6 {
        font-size: 1rem;
        margin-bottom: 8px;
    }
    
    .problem-item p,
    .strength-item p {
        font-size: 0.9rem;
        margin-bottom: 8px;
    }
    
    /* 示例文本优化 */
    .example-text {
        padding: 8px;
        font-size: 0.85rem;
        margin: 8px 0;
    }
    
    /* 维度分数条优化 */
    .dimension-score {
        flex-direction: column;
        align-items: stretch;
        padding: 12px;
    }
    
    .dimension-score > div:first-child {
        width: 100% !important;
        margin-bottom: 10px;
    }
    
    .score-bar {
        width: 100% !important;
        margin-bottom: 8px;
    }
    
    .dimension-score > div:last-child {
        width: 100% !important;
        text-align: center !important;
    }
    
    /* 作文示例优化 */
    .mb-3 h6 {
        font-size: 0.95rem;
        line-height: 1.4;
    }
    
    /* 小文本优化 */
    small {
        font-size: 0.8rem;
    }
    
    /* 图标优化 */
    .fas {
        font-size: 0.9rem;
    }
}

@media (max-width: 576px) {
    /* 超小屏幕优化 */
    .stat-number {
        font-size: 1.8rem;
    }
    
    .chart-container {
        height: 250px;
    }
    
    .card-tools {
        margin-top: 10px;
    }
    
    .card-tools .btn {
        width: 100%;
        margin-bottom: 5px;
    }
    
    .problem-item,
    .strength-item {
        padding: 10px;
    }
    
    .example-text {
        font-size: 0.8rem;
        padding: 6px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <!-- 页面标题 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-chart-bar"></i>
                        作业报告：{{ assignment.title }}
                    </h3>
                    <div class="card-tools">
                        <a href="{{ url_for('assignments.download_assignment_report', assignment_id=assignment.id) }}" class="btn btn-success btn-sm">
                            <i class="fas fa-download"></i> 下载 DOCX 报告
                        </a>
                        <a href="{{ url_for('assignments.generate_report', assignment_id=assignment.id) }}" class="btn btn-primary btn-sm">
                            <i class="fas fa-sync-alt"></i> 重新生成报告
                        </a>
                        <a href="{{ url_for('assignments.assignment_detail', assignment_id=assignment.id) }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-arrow-left"></i> 返回作业详情
                        </a>
                    </div>
                </div>
            </div>

            <!-- 统计概览 -->
            <div class="row">
                <div class="col-6 col-md-3">
                    <div class="stat-card text-center">
                        <div class="stat-number">{{ report_data.basic_statistics.average_score|round(1) }}</div>
                        <div class="stat-label">班级平均分</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="stat-card text-center">
                        <div class="stat-number">{{ report_data.basic_statistics.total_essays }}</div>
                        <div class="stat-label">作文总数</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="stat-card text-center">
                        <div class="stat-number">{{ report_data.basic_statistics.max_score|round(1) }}</div>
                        <div class="stat-label">最高分</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="stat-card text-center">
                        <div class="stat-number">{{ ((report_data.basic_statistics.average_score / assignment.grading_standard.total_score) * 100)|round(1) }}%</div>
                        <div class="stat-label">平均得分率</div>
                    </div>
                </div>
            </div>

            <!-- 图表展示 -->
            <div class="row">
                <!-- 分数分布图 -->
                <div class="col-12 col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">分数分布</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="scoreDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 维度雷达图 -->
                <div class="col-12 col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">各维度平均得分率</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="dimensionRadarChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 问题类型分析 -->
            <div class="row">
                <div class="col-12 col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">问题类型分布</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="problemTypePieChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 字数分布 -->
                <div class="col-12 col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">作文字数分布</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="wordCountChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI分析结果 -->
            <div class="row">
                <!-- 班级共性问题 -->
                <div class="col-12 col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-exclamation-triangle text-warning"></i>
                                班级共性问题
                            </h5>
                        </div>
                        <div class="card-body">
                            {% for problem in report_data.common_issues %}
            <div class="problem-item" style="border: 1px solid #e9ecef; border-radius: 5px; padding: 15px; margin-bottom: 15px;">
                <h6><strong>{{ problem.type }}</strong></h6>
                <p>{{ problem.description }}</p>
                {% if problem.examples %}
                <div class="example-text">
                    <strong>示例：</strong>{{ problem.examples[0] }}
                </div>
                {% endif %}
                <small class="text-muted">出现频率：{{ problem.percentage }}%</small>
                <div class="mt-2">
                    <strong>改进建议：</strong>{{ problem.suggestions }}
                </div>
                
                <!-- 显示详细示例 -->
                {% if problem.detailed_examples %}
                <div class="mt-3">
                    <strong>具体示例：</strong>
                    <div class="list-group mt-2">
                        {% for example in problem.detailed_examples %}
                        <a href="{{ url_for('assignments.review_submission', submission_id=example.essay_id) }}" target="_blank" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ example.student_name }}</h6>
                                <small><i class="fas fa-external-link-alt"></i></small>
                            </div>
                            <p class="mb-1">{{ example.problem_sentence }}</p>
                            <small class="text-muted">位置: {{ example.sentence_position }} | {{ example.problem_explanation }}</small>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- 优秀作文特点 -->
                <div class="col-12 col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-star text-success"></i>
                                优秀作文特点
                            </h5>
                        </div>
                        <div class="card-body">
                            {% for strength in report_data.excellent_features %}
            <div class="strength-item" style="border: 1px solid #e9ecef; border-radius: 5px; padding: 15px; margin-bottom: 15px;">
                <h6><strong>{{ strength.feature }}</strong></h6>
                <p>{{ strength.description }}</p>
                {% if strength.examples %}
                <div class="example-text">
                    <strong>优秀示例：</strong>{{ strength.examples[0] }}
                </div>
                {% endif %}
                
                <!-- 显示详细示例 -->
                {% if strength.detailed_examples %}
                <div class="mt-3">
                    <strong>具体示例：</strong>
                    <div class="list-group mt-2">
                        {% for example in strength.detailed_examples %}
                        <a href="{{ url_for('assignments.review_submission', submission_id=example.essay_id) }}" target="_blank" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ example.student_name }}</h6>
                                <small><i class="fas fa-external-link-alt"></i></small>
                            </div>
                            <p class="mb-1">{{ example.excellent_sentence }}</p>
                            <small class="text-muted">位置: {{ example.sentence_position }} | {{ example.excellence_explanation }}</small>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 各维度详细分析 -->
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-chart-line"></i>
                                各维度详细分析
                            </h5>
                        </div>
                        <div class="card-body">
                            {% for dimension_name, dimension_data in report_data.dimension_statistics.items() %}
                            <div class="dimension-score">
                                <div style="width: 30%;">
                                    <strong>{{ dimension_name }}</strong>
                                    <br><small class="text-muted">平均分：{{ dimension_data.average|round(1) }}/{{ dimension_data.max }}</small>
                                </div>
                                <div class="score-bar">
                                    <div class="score-fill" style="width: {{ (dimension_data.average / dimension_data.max * 100)|round(1) }}%;"></div>
                                </div>
                                <div style="width: 10%; text-align: right;">
                                    <strong>{{ ((dimension_data.average / dimension_data.max) * 100)|round(1) }}%</strong>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 优秀和需改进作文示例 -->
            <div class="row">
                <div class="col-12 col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-trophy text-warning"></i>
                                优秀作文示例
                            </h5>
                        </div>
                        <div class="card-body">
                            {% for example in report_data.top_essays %}
                            <div class="mb-3 clickable-essay" data-essay-id="{{ example.essay_id }}" style="cursor: pointer; border: 1px solid #e9ecef; border-radius: 5px; padding: 10px; transition: background-color 0.2s;">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6><strong>{{ example.student_name }}</strong> - 得分：{{ example.score or '未评分' }}/{{ assignment.grading_standard.total_score }}
                                            <i class="fas fa-external-link-alt ml-2 text-muted" style="font-size: 12px;"></i>
                                        </h6>
                                        <div class="example-text">
                                            {{ example.content_preview }}
                                        </div>
                                    </div>
                                    <div class="ml-2">
                                        <a href="{{ url_for('assignments.download_essay_report', essay_id=example.essay_id) }}" 
                                           class="btn btn-sm btn-outline-success" title="下载此作文的DOCX报告">
                                            <i class="fas fa-download"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="col-12 col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-edit text-info"></i>
                                需改进作文示例
                            </h5>
                        </div>
                        <div class="card-body">
                            {% for example in report_data.bottom_essays %}
                            <div class="mb-3 clickable-essay" data-essay-id="{{ example.essay_id }}" style="cursor: pointer; border: 1px solid #e9ecef; border-radius: 5px; padding: 10px; transition: background-color 0.2s;">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6><strong>{{ example.student_name }}</strong> - 得分：{{ example.score or '未评分' }}/{{ assignment.grading_standard.total_score }}
                                            <i class="fas fa-external-link-alt ml-2 text-muted" style="font-size: 12px;"></i>
                                        </h6>
                                        <div class="example-text">
                                            {{ example.content_preview }}
                                        </div>
                                    </div>
                                    <div class="ml-2">
                                        <a href="{{ url_for('assignments.download_essay_report', essay_id=example.essay_id) }}" 
                                           class="btn btn-sm btn-outline-success" title="下载此作文的DOCX报告">
                                            <i class="fas fa-download"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 报告生成信息 -->
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body text-center text-muted">
                            <small>
                                报告生成时间：{{ report.generated_at.strftime('%Y-%m-%d %H:%M:%S') }}
                                | 基于 {{ report_data.basic_statistics.total_essays }} 篇已评分作文生成
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 分数分布图
const scoreCtx = document.getElementById('scoreDistributionChart').getContext('2d');
const scoreChart = new Chart(scoreCtx, {
    type: 'bar',
    data: {
        labels: {{ report_data.charts.score_distribution.labels|tojson }},
        datasets: [{
            label: '学生人数',
            data: {{ report_data.charts.score_distribution.data|tojson }},
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: {
                    font: {
                        size: window.innerWidth < 768 ? 10 : 12
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1,
                    font: {
                        size: window.innerWidth < 768 ? 10 : 12
                    }
                }
            },
            x: {
                ticks: {
                    font: {
                        size: window.innerWidth < 768 ? 10 : 12
                    }
                }
            }
        }
    }
});

// 维度雷达图
const radarCtx = document.getElementById('dimensionRadarChart').getContext('2d');
const radarChart = new Chart(radarCtx, {
    type: 'radar',
    data: {
        labels: {{ report_data.charts.dimension_radar.labels|tojson }},
        datasets: [{
            label: '平均得分率(%)',
            data: {{ report_data.charts.dimension_radar.data|tojson }},
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            borderColor: 'rgba(255, 99, 132, 1)',
            pointBackgroundColor: 'rgba(255, 99, 132, 1)',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: 'rgba(255, 99, 132, 1)'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: {
                    font: {
                        size: window.innerWidth < 768 ? 10 : 12
                    }
                }
            }
        },
        scales: {
            r: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    font: {
                        size: window.innerWidth < 768 ? 8 : 10
                    }
                },
                pointLabels: {
                    font: {
                        size: window.innerWidth < 768 ? 9 : 11
                    }
                }
            }
        }
    }
});

// 问题类型饼图
const problemCtx = document.getElementById('problemTypePieChart').getContext('2d');
const problemChart = new Chart(problemCtx, {
    type: 'pie',
    data: {
        labels: {{ report_data.charts.problem_types.labels|tojson }},
        datasets: [{
            data: {{ report_data.charts.problem_types.data|tojson }},
            backgroundColor: [
                '#FF6384',
                '#36A2EB',
                '#FFCE56',
                '#4BC0C0',
                '#9966FF',
                '#FF9F40'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: window.innerWidth < 768 ? 'bottom' : 'right',
                labels: {
                    font: {
                        size: window.innerWidth < 768 ? 10 : 12
                    },
                    padding: window.innerWidth < 768 ? 10 : 20
                }
            }
        }
    }
});

// 字数分布图
const wordCtx = document.getElementById('wordCountChart').getContext('2d');
const wordChart = new Chart(wordCtx, {
    type: 'line',
    data: {
        labels: {{ report_data.charts.word_count.labels|tojson }},
        datasets: [{
            label: '作文数量',
            data: {{ report_data.charts.word_count.data|tojson }},
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: {
                    font: {
                        size: window.innerWidth < 768 ? 10 : 12
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1,
                    font: {
                        size: window.innerWidth < 768 ? 10 : 12
                    }
                }
            },
            x: {
                ticks: {
                    font: {
                        size: window.innerWidth < 768 ? 10 : 12
                    }
                }
            }
        }
    }
});

// 添加交互功能
document.addEventListener('DOMContentLoaded', function() {
    // 作文示例点击跳转
    document.querySelectorAll('.clickable-essay').forEach(function(element) {
        element.addEventListener('click', function() {
            const essayId = this.getAttribute('data-essay-id');
            if (essayId) {
                // 跳转到作文详情页面
                window.open(`/essays/${essayId}`, '_blank');
            }
        });
        
        // 添加悬停效果
        element.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f8f9fa';
        });
        
        element.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
    });
    
    // 问题类型饼图点击事件（暂时禁用，因为详细信息已直接显示）
    // problemChart.options.onClick = function(event, elements) {
    //     if (elements.length > 0) {
    //         const index = elements[0].index;
    //         const problemType = problemChart.data.labels[index];
    //         // 详细信息已在页面中直接显示
    //     }
    // };
    
    // 为饼图添加悬停效果
    problemChart.options.onHover = function(event, activeElements) {
        event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
    };
    
    // 移除了不再需要的点击事件处理，因为现在直接显示详细示例
});

// 移除了showProblemDetails函数，因为现在直接显示详细示例

// 移除了showFeatureDetails函数，因为现在直接显示详细示例

// 移除了searchEssayByExample函数，因为现在直接显示详细示例
</script>
{% endblock %}