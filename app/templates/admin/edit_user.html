{% extends "base.html" %}

{% block title %}编辑用户 - 管理员后台{% endblock %}

{% block content %}
<div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-user-edit"></i> 编辑用户</h2>
                <a href="{{ url_for('admin.users') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> 返回用户列表
                </a>
            </div>
            
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">用户信息 - {{ user.username }}</h5>
                        </div>
                        <div class="card-body">
                            <!-- 用户基本信息展示 -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-info-circle"></i> 用户基本信息</h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <strong>用户ID:</strong> {{ user.id }}<br>
                                                <strong>注册时间:</strong> {{ user.created_at.strftime('%Y-%m-%d %H:%M:%S') if user.created_at else '未知' }}<br>
                                                <strong>最后登录:</strong> {{ user.last_login.strftime('%Y-%m-%d %H:%M:%S') if user.last_login else '从未登录' }}
                                            </div>
                                            <div class="col-md-6">
                                                <strong>当前角色:</strong> 
                                                {% if user.role == 'admin' %}
                                                    <span class="badge bg-danger">管理员</span>
                                                {% elif user.role == 'teacher' %}
                                                    <span class="badge bg-success">教师</span>
                                                {% elif user.role == 'student' %}
                                                    <span class="badge bg-primary">学生</span>
                                                {% endif %}<br>
                                                <strong>账户状态:</strong> 
                                                {% if user.is_active %}
                                                    <span class="badge bg-success">活跃</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">禁用</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <form method="POST">
                                {{ form.hidden_tag() }}
                                
                                <!-- 基本信息 -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="{{ form.email.id }}" class="form-label">{{ form.email.label.text }} <span class="text-danger">*</span></label>
                                        {{ form.email(class="form-control" + (" is-invalid" if form.email.errors else "")) }}
                                        {% if form.email.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in form.email.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ form.username.id }}" class="form-label">{{ form.username.label.text }} <span class="text-danger">*</span></label>
                                        {{ form.username(class="form-control" + (" is-invalid" if form.username.errors else "")) }}
                                        {% if form.username.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in form.username.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="{{ form.password.id }}" class="form-label">{{ form.password.label.text }}</label>
                                        {{ form.password(class="form-control" + (" is-invalid" if form.password.errors else "")) }}
                                        {% if form.password.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in form.password.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">留空则不修改密码</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ form.phone.id }}" class="form-label">{{ form.phone.label.text }}</label>
                                        {{ form.phone(class="form-control" + (" is-invalid" if form.phone.errors else "")) }}
                                        {% if form.phone.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in form.phone.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- 角色和个人信息 -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="{{ form.role.id }}" class="form-label">{{ form.role.label.text }} <span class="text-danger">*</span></label>
                                        {{ form.role(class="form-select" + (" is-invalid" if form.role.errors else ""), id="roleSelect") }}
                                        {% if form.role.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in form.role.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        {% if user.id == current_user.id %}
                                            <div class="form-text text-warning">
                                                <i class="fas fa-exclamation-triangle"></i> 注意：修改自己的角色可能影响后台访问权限
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ form.full_name.id }}" class="form-label">{{ form.full_name.label.text }} <span class="text-danger">*</span></label>
                                        {{ form.full_name(class="form-control" + (" is-invalid" if form.full_name.errors else "")) }}
                                        {% if form.full_name.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in form.full_name.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="{{ form.nickname.id }}" class="form-label">{{ form.nickname.label.text }}</label>
                                        {{ form.nickname(class="form-control" + (" is-invalid" if form.nickname.errors else "")) }}
                                        {% if form.nickname.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in form.nickname.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6" id="schoolField">
                                        <label for="{{ form.school_id.id }}" class="form-label">{{ form.school_id.label.text }}</label>
                                        {{ form.school_id(class="form-select" + (" is-invalid" if form.school_id.errors else "")) }}
                                        {% if form.school_id.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in form.school_id.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">教师角色需要选择所属学校</div>
                                    </div>
                                </div>
                                
                                <!-- 关联信息展示 -->
                                {% if user.role == 'student' and user.student_profile and user.student_profile.enrollments %}
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <div class="alert alert-light">
                                            <h6><i class="fas fa-graduation-cap"></i> 学生班级信息</h6>
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>学校</th>
                                                            <th>班级</th>
                                                            <th>入学年份</th>
                                                            <th>毕业年份</th>
                                                            <th>加入时间</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for enrollment in user.student_profile.enrollments %}
                                                        <tr>
                                                            <td>{{ enrollment.classroom.school.name }}</td>
                                                            <td>{{ enrollment.classroom.class_name }}</td>
                                                            <td>{{ enrollment.classroom.entry_year }}</td>
                                                            <td>{{ enrollment.classroom.graduate_year }}</td>
                                                            <td>{{ enrollment.enrolled_at.strftime('%Y-%m-%d') if enrollment.enrolled_at else '-' }}</td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <a href="{{ url_for('admin.users') }}" class="btn btn-secondary me-md-2">
                                        <i class="fas fa-times"></i> 取消
                                    </a>
                                    {{ form.submit(class="btn btn-primary") }}
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 根据角色显示/隐藏学校选择字段
document.getElementById('roleSelect').addEventListener('change', function() {
    const schoolField = document.getElementById('schoolField');
    const schoolSelect = document.querySelector('#{{ form.school_id.id }}');
    
    if (this.value === 'teacher') {
        schoolField.style.display = 'block';
        schoolSelect.required = true;
    } else {
        schoolField.style.display = 'block'; // 保持显示，但不是必填
        schoolSelect.required = false;
        if (this.value === 'admin') {
            schoolSelect.value = '0'; // 管理员默认不选择学校
        }
    }
});

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    const roleSelect = document.getElementById('roleSelect');
    roleSelect.dispatchEvent(new Event('change'));
});
</script>
{% endblock %}